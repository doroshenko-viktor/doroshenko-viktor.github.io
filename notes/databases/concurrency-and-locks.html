<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>SQL Databases Concurrency And Locks</title><link rel="icon" href="/images/favicon.ico"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/b65b5b41f2379875.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b65b5b41f2379875.css" data-n-g=""/><link rel="preload" href="/_next/static/css/0d9654b911e08999.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0d9654b911e08999.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-fc97f3f1282ce3ed.js" defer=""></script><script src="/_next/static/chunks/main-f4ae3437c92c1efc.js" defer=""></script><script src="/_next/static/chunks/pages/_app-85d7488a393e293e.js" defer=""></script><script src="/_next/static/chunks/211-ca3cd870e26e881a.js" defer=""></script><script src="/_next/static/chunks/pages/notes/%5B...noteKey%5D-bc6552c3ae1e3718.js" defer=""></script><script src="/_next/static/6V8_yxN3djhrhbRemYkax/_buildManifest.js" defer=""></script><script src="/_next/static/6V8_yxN3djhrhbRemYkax/_ssgManifest.js" defer=""></script><script src="/_next/static/6V8_yxN3djhrhbRemYkax/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><section class="Layout_centeredSection__nmU9U"><ul class="NavigationBar_navbar__CBMoV"><li class="NavigationBar_navitem__LKB5F"><a class="NavigationBar_navitemContent__jEyWq" href="/">Home</a><span class="NavigationBar_separator__qvEVD">|</span></li><li class="NavigationBar_navitem__LKB5F"><button class="NavigationBar_navitemContent__jEyWq">Back</button><span class="NavigationBar_separator__qvEVD">|</span></li></ul><h1 class="NoteFormattedContent_noteTitle__Oi9sD">SQL Databases Concurrency And Locks</h1><article class="NoteFormattedContent_note__8cHeE">
<h2>Introduction</h2>
<p>Transactions are fundamental building blocks of database systems that ensure data integrity and consistency. In PostgreSQL, understanding how transactions work and how different isolation levels affect concurrent operations is crucial for building reliable applications.</p>
<p>This guide explores PostgreSQL's transaction model, isolation levels, concurrency control mechanisms, and best practices for handling transactions in production environments.</p>
<h2>What is a Transaction?</h2>
<p>A transaction is a sequence of one or more SQL operations that are treated as a single unit of work. Transactions follow the ACID properties:</p>
<ul>
  <li><strong>Atomicity</strong>: All operations in a transaction succeed or all fail together</li>
  <li><strong>Consistency</strong>: Transactions move the database from one valid state to another</li>
  <li><strong>Isolation</strong>: Concurrent transactions don't interfere with each other</li>
  <li><strong>Durability</strong>: Once committed, changes persist even after system failures</li>
</ul>
<h2>Basic Transaction Commands</h2>
<h3>Starting and Ending Transactions</h3>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Begin a transaction</span>
<span class="hljs-keyword">BEGIN</span>;

<span class="hljs-comment">-- Perform operations</span>
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">+</span> <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

<span class="hljs-comment">-- Commit the transaction</span>
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<h3>Rolling Back Transactions</h3>
<pre><code class="hljs language-sql"><span class="hljs-keyword">BEGIN</span>;

<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-comment">-- Something went wrong, undo everything</span>
<span class="hljs-keyword">ROLLBACK</span>;
</code></pre>
<h3>Savepoints</h3>
<p>Savepoints allow you to partially rollback a transaction:</p>
<pre><code class="hljs language-sql"><span class="hljs-keyword">BEGIN</span>;

<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-keyword">SAVEPOINT</span> my_savepoint;

<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">+</span> <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

<span class="hljs-comment">-- Rollback only to the savepoint</span>
<span class="hljs-keyword">ROLLBACK</span> <span class="hljs-keyword">TO</span> <span class="hljs-keyword">SAVEPOINT</span> my_savepoint;

<span class="hljs-comment">-- The first UPDATE is still active</span>
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<h2>Isolation Levels</h2>
<p>PostgreSQL implements four standard SQL isolation levels, each providing different guarantees about what phenomena can occur when transactions run concurrently.</p>
<h3>Read Phenomena</h3>
<p>Before discussing isolation levels, it's important to understand the read phenomena they prevent:</p>
<p><strong>Dirty Read</strong>: Reading uncommitted changes from another transaction</p>
<p><strong>Non-Repeatable Read</strong>: Reading the same row twice in a transaction and getting different values because another transaction modified and committed the row</p>
<p><strong>Phantom Read</strong>: Re-executing a query and finding rows that weren't there before because another transaction inserted and committed new rows</p>
<p><strong>Serialization Anomaly</strong>: The result of successfully committing a group of transactions is inconsistent with all possible orderings of running those transactions one at a time</p>
<h3>PostgreSQL Isolation Levels</h3>
<table>
  <thead>
    <tr>
      <th>Isolation Level</th>
      <th>Dirty Read</th>
      <th>Non-Repeatable Read</th>
      <th>Phantom Read</th>
      <th>Serialization Anomaly</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Read Uncommitted</td>
      <td>Not possible*</td>
      <td>Possible</td>
      <td>Possible</td>
      <td>Possible</td>
    </tr>
    <tr>
      <td>Read Committed</td>
      <td>Not possible</td>
      <td>Possible</td>
      <td>Possible</td>
      <td>Possible</td>
    </tr>
    <tr>
      <td>Repeatable Read</td>
      <td>Not possible</td>
      <td>Not possible</td>
      <td>Not possible**</td>
      <td>Possible</td>
    </tr>
    <tr>
      <td>Serializable</td>
      <td>Not possible</td>
      <td>Not possible</td>
      <td>Not possible</td>
      <td>Not possible</td>
    </tr>
  </tbody>
</table>
<p>*PostgreSQL treats Read Uncommitted as Read Committed<br>**PostgreSQL prevents phantom reads at Repeatable Read level</p>
<h3>Read Committed (Default)</h3>
<p>This is PostgreSQL's default isolation level. Each query within a transaction sees a snapshot of the database as of the start of that query.</p>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Session 1</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> balance <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-comment">-- Returns 1000</span>
</code></pre>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Session 2</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> <span class="hljs-number">1500</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Session 1 (continuing)</span>
<span class="hljs-keyword">SELECT</span> balance <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-comment">-- Returns 1500 (sees the committed change)</span>
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<p><strong>Use cases</strong>: Most applications work well with Read Committed. It provides good performance while preventing dirty reads.</p>
<h3>Repeatable Read</h3>
<p>Each query in a transaction sees a snapshot of the database as of the start of the first query in that transaction.</p>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Session 1</span>
<span class="hljs-keyword">BEGIN</span> TRANSACTION ISOLATION LEVEL REPEATABLE READ;
<span class="hljs-keyword">SELECT</span> balance <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-comment">-- Returns 1000</span>
</code></pre>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Session 2</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> <span class="hljs-number">1500</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Session 1 (continuing)</span>
<span class="hljs-keyword">SELECT</span> balance <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-comment">-- Still returns 1000 (doesn't see the committed change)</span>
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<p><strong>Use cases</strong>: Long-running reports, data exports, or any operation that needs a consistent view of data throughout the transaction.</p>
<h3>Serializable</h3>
<p>The strictest isolation level. Transactions execute as if they ran one at a time, with no concurrency. PostgreSQL uses Serializable Snapshot Isolation (SSI) to implement this efficiently.</p>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Session 1</span>
<span class="hljs-keyword">BEGIN</span> TRANSACTION ISOLATION LEVEL SERIALIZABLE;
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">SUM</span>(balance) <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> type <span class="hljs-operator">=</span> <span class="hljs-string">'checking'</span>;
<span class="hljs-comment">-- Returns 10000</span>
</code></pre>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Session 2</span>
<span class="hljs-keyword">BEGIN</span> TRANSACTION ISOLATION LEVEL SERIALIZABLE;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> accounts (type, balance) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'checking'</span>, <span class="hljs-number">500</span>);
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Session 1 (continuing)</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> audit_log (total_checking)
<span class="hljs-keyword">VALUES</span> ((<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">SUM</span>(balance) <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> type <span class="hljs-operator">=</span> <span class="hljs-string">'checking'</span>));
<span class="hljs-comment">-- ERROR: could not serialize access due to read/write dependencies</span>
</code></pre>
<p><strong>Use cases</strong>: Financial systems, inventory management, or any scenario where serialization anomalies would cause data corruption.</p>
<h3>Setting Isolation Levels</h3>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- For a single transaction</span>
<span class="hljs-keyword">BEGIN</span> TRANSACTION ISOLATION LEVEL REPEATABLE READ;

<span class="hljs-comment">-- For the current session</span>
<span class="hljs-keyword">SET</span> SESSION CHARACTERISTICS <span class="hljs-keyword">AS</span> TRANSACTION ISOLATION LEVEL REPEATABLE READ;

<span class="hljs-comment">-- Using SET TRANSACTION</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SET</span> TRANSACTION ISOLATION LEVEL SERIALIZABLE;
</code></pre>
<h2>Multi-Version Concurrency Control (MVCC)</h2>
<p>PostgreSQL uses MVCC to implement isolation levels efficiently. Instead of locking rows, it maintains multiple versions of data:</p>
<ul>
  <li>When a row is updated, PostgreSQL creates a new version rather than overwriting the old one</li>
  <li>Each transaction sees the appropriate version based on its isolation level and start time</li>
  <li>Old versions are cleaned up by the VACUUM process</li>
</ul>
<h3>Benefits of MVCC</h3>
<ul>
  <li>Readers don't block writers</li>
  <li>Writers don't block readers</li>
  <li>High concurrency with minimal locking</li>
  <li>No dirty reads</li>
</ul>
<h3>Transaction IDs</h3>
<p>Every transaction receives a unique transaction ID (XID). Each row version is tagged with XIDs indicating when it was created and deleted:</p>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- View transaction IDs (requires superuser or appropriate permissions)</span>
<span class="hljs-keyword">SELECT</span> txid_current();

<span class="hljs-comment">-- See row versions (for debugging)</span>
<span class="hljs-keyword">SELECT</span> xmin, xmax, <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> accounts;
</code></pre>
<h2>Locking in PostgreSQL</h2>
<p>While MVCC reduces the need for locks, PostgreSQL still uses locks for certain operations.</p>
<h3>Lock Modes</h3>
<p><strong>Table-Level Locks</strong>:</p>
<ul>
  <li>ACCESS SHARE: Acquired by SELECT</li>
  <li>ROW SHARE: Acquired by SELECT FOR UPDATE</li>
  <li>ROW EXCLUSIVE: Acquired by UPDATE, DELETE, INSERT</li>
  <li>SHARE UPDATE EXCLUSIVE: Acquired by VACUUM, CREATE INDEX CONCURRENTLY</li>
  <li>SHARE: Acquired by CREATE INDEX</li>
  <li>SHARE ROW EXCLUSIVE: Acquired by CREATE TRIGGER</li>
  <li>EXCLUSIVE: Blocks all concurrent access except ACCESS SHARE</li>
  <li>ACCESS EXCLUSIVE: Acquired by DROP TABLE, TRUNCATE, REINDEX, VACUUM FULL</li>
</ul>
<p><strong>Row-Level Locks</strong>:</p>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Lock rows for update (blocks other locks)</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;

<span class="hljs-comment">-- Lock rows but allow other shared locks</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FOR</span> SHARE;

<span class="hljs-comment">-- Skip locked rows instead of waiting</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> queue <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'pending'</span>
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">SKIP</span> LOCKED LIMIT <span class="hljs-number">1</span>;

<span class="hljs-comment">-- Don't wait for locks, error immediately</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span> NOWAIT;
</code></pre>
<h3>Advisory Locks</h3>
<p>PostgreSQL provides advisory locks for application-level coordination:</p>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Session-level advisory lock</span>
<span class="hljs-keyword">SELECT</span> pg_advisory_lock(<span class="hljs-number">12345</span>);
<span class="hljs-keyword">SELECT</span> pg_advisory_unlock(<span class="hljs-number">12345</span>);

<span class="hljs-comment">-- Transaction-level advisory lock</span>
<span class="hljs-keyword">SELECT</span> pg_advisory_xact_lock(<span class="hljs-number">12345</span>);
<span class="hljs-comment">-- Automatically released at transaction end</span>

<span class="hljs-comment">-- Try lock without blocking</span>
<span class="hljs-keyword">SELECT</span> pg_try_advisory_lock(<span class="hljs-number">12345</span>);
</code></pre>
<h2>Handling Deadlocks</h2>
<p>A deadlock occurs when transactions wait for each other in a cycle. PostgreSQL automatically detects and resolves deadlocks by aborting one transaction.</p>
<h3>Example Deadlock</h3>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Session 1</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-comment">-- Waiting to update id = 2</span>
</code></pre>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Session 2</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
<span class="hljs-comment">-- Waiting to update id = 1</span>
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">+</span> <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-comment">-- ERROR: deadlock detected</span>
</code></pre>
<h3>Preventing Deadlocks</h3>
<p>Always access resources in the same order across all transactions:</p>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Good: consistent ordering</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> LEAST(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">+</span> <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> GREATEST(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<p>Use timeouts:</p>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Set statement timeout</span>
<span class="hljs-keyword">SET</span> statement_timeout <span class="hljs-operator">=</span> <span class="hljs-string">'5s'</span>;

<span class="hljs-comment">-- Set lock timeout</span>
<span class="hljs-keyword">SET</span> lock_timeout <span class="hljs-operator">=</span> <span class="hljs-string">'2s'</span>;
</code></pre>
<h2>Serialization Failures</h2>
<p>At Repeatable Read and Serializable levels, transactions may fail with serialization errors:</p>
<pre><code class="hljs language-vbnet"><span class="hljs-symbol">ERROR:</span> could <span class="hljs-built_in">not</span> serialize access due <span class="hljs-keyword">to</span> concurrent update
<span class="hljs-symbol">ERROR:</span> could <span class="hljs-built_in">not</span> serialize access due <span class="hljs-keyword">to</span> read/write dependencies among transactions
</code></pre>
<h3>Handling Serialization Errors</h3>
<p>Always implement retry logic:</p>
<pre><code class="hljs language-python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">transfer_money</span>(<span class="hljs-params">from_id, to_id, amount</span>):
    max_retries = <span class="hljs-number">3</span>
    <span class="hljs-keyword">for</span> attempt <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_retries):
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> connection.cursor() <span class="hljs-keyword">as</span> cur:
                cur.execute(<span class="hljs-string">"BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE"</span>)
                cur.execute(
                    <span class="hljs-string">"UPDATE accounts SET balance = balance - %s WHERE id = %s"</span>,
                    (amount, from_id)
                )
                cur.execute(
                    <span class="hljs-string">"UPDATE accounts SET balance = balance + %s WHERE id = %s"</span>,
                    (amount, to_id)
                )
                cur.execute(<span class="hljs-string">"COMMIT"</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">except</span> SerializationFailure:
            <span class="hljs-keyword">if</span> attempt &#x3C; max_retries - <span class="hljs-number">1</span>:
                time.sleep(<span class="hljs-number">0.1</span> * (<span class="hljs-number">2</span> ** attempt))  <span class="hljs-comment"># Exponential backoff</span>
                <span class="hljs-keyword">continue</span>
            <span class="hljs-keyword">raise</span>
</code></pre>
<h2>Transaction Best Practices</h2>
<h3>Keep Transactions Short</h3>
<p>Long-running transactions hold locks, prevent VACUUM from cleaning old row versions, and increase the chance of conflicts:</p>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Bad: transaction open while waiting for user input</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">123</span>;
<span class="hljs-comment">-- Application waits for user to confirm</span>
<span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> quantity <span class="hljs-operator">=</span> quantity <span class="hljs-operator">-</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">123</span>;
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- Good: transaction only during database operations</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">123</span>;
<span class="hljs-comment">-- Application waits for user to confirm</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> quantity <span class="hljs-operator">=</span> quantity <span class="hljs-operator">-</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">123</span>;
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<h3>Use Appropriate Isolation Levels</h3>
<p>Don't use stricter isolation than necessary:</p>
<ul>
  <li>Use Read Committed for most operations</li>
  <li>Use Repeatable Read for reports and data exports</li>
  <li>Use Serializable only when business logic requires it</li>
</ul>
<h3>Handle Errors Properly</h3>
<p>Always handle transaction errors:</p>
<pre><code class="hljs language-sql"><span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SAVEPOINT</span> before_risky_operation;

<span class="hljs-comment">-- Risky operation</span>
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-comment">-- Check constraint violation</span>
DO $$
<span class="hljs-keyword">BEGIN</span>
    IF (<span class="hljs-keyword">SELECT</span> balance <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>) <span class="hljs-operator">&#x3C;</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
        <span class="hljs-keyword">ROLLBACK</span> <span class="hljs-keyword">TO</span> <span class="hljs-keyword">SAVEPOINT</span> before_risky_operation;
        RAISE EXCEPTION <span class="hljs-string">'Insufficient funds'</span>;
    <span class="hljs-keyword">END</span> IF;
<span class="hljs-keyword">END</span> $$;

<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<h3>Use Connection Pooling Wisely</h3>
<p>Connection pools can complicate transaction management:</p>
<pre><code class="hljs language-python"><span class="hljs-comment"># Ensure transactions are completed before returning to pool</span>
<span class="hljs-keyword">try</span>:
    connection = pool.get_connection()
    <span class="hljs-comment"># Do work</span>
    connection.commit()
<span class="hljs-keyword">except</span> Exception:
    connection.rollback()
    <span class="hljs-keyword">raise</span>
<span class="hljs-keyword">finally</span>:
    pool.return_connection(connection)
</code></pre>
<h3>Monitor Transaction Age</h3>
<p>Long-running transactions cause problems. Monitor them:</p>
<pre><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span>
    pid,
    now() <span class="hljs-operator">-</span> xact_start <span class="hljs-keyword">AS</span> duration,
    state,
    query
<span class="hljs-keyword">FROM</span> pg_stat_activity
<span class="hljs-keyword">WHERE</span> xact_start <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> xact_start;
</code></pre>
<h3>Avoid Explicit Locking When Possible</h3>
<p>Let MVCC do its job. Only use explicit locks when necessary:</p>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Usually unnecessary</span>
<span class="hljs-keyword">BEGIN</span>;
LOCK <span class="hljs-keyword">TABLE</span> accounts <span class="hljs-keyword">IN</span> EXCLUSIVE MODE;
<span class="hljs-comment">-- operations</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- Better: let MVCC handle it</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-comment">-- operations</span>
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<h2>Common Patterns</h2>
<h3>Optimistic Locking with Version Columns</h3>
<pre><code class="hljs language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> documents (
    id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    content TEXT,
    version <span class="hljs-type">INTEGER</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>
);

<span class="hljs-comment">-- Update with version check</span>
<span class="hljs-keyword">UPDATE</span> documents
<span class="hljs-keyword">SET</span> content <span class="hljs-operator">=</span> <span class="hljs-string">'new content'</span>, version <span class="hljs-operator">=</span> version <span class="hljs-operator">+</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">123</span> <span class="hljs-keyword">AND</span> version <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;

<span class="hljs-comment">-- Check if update succeeded</span>
<span class="hljs-keyword">GET</span> DIAGNOSTICS rows_updated <span class="hljs-operator">=</span> ROW_COUNT;
IF rows_updated <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
    RAISE EXCEPTION <span class="hljs-string">'Document was modified by another user'</span>;
<span class="hljs-keyword">END</span> IF;
</code></pre>
<h3>Queue Processing with SKIP LOCKED</h3>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Multiple workers can process queue concurrently</span>
<span class="hljs-keyword">BEGIN</span>;

<span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> job_queue
<span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'pending'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">SKIP</span> LOCKED
LIMIT <span class="hljs-number">1</span>;

<span class="hljs-keyword">UPDATE</span> job_queue
<span class="hljs-keyword">SET</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'processing'</span>, started_at <span class="hljs-operator">=</span> now()
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-operator">&#x3C;</span>selected_id<span class="hljs-operator">></span>;

<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- Process the job</span>

<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> job_queue
<span class="hljs-keyword">SET</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'completed'</span>, completed_at <span class="hljs-operator">=</span> now()
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-operator">&#x3C;</span>selected_id<span class="hljs-operator">></span>;
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<h3>Conditional Inserts</h3>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Insert only if not exists</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (email, name)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'user@example.com'</span>, <span class="hljs-string">'John Doe'</span>)
<span class="hljs-keyword">ON</span> CONFLICT (email) DO NOTHING;

<span class="hljs-comment">-- Insert or update</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> user_stats (user_id, login_count)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-number">123</span>, <span class="hljs-number">1</span>)
<span class="hljs-keyword">ON</span> CONFLICT (user_id)
DO <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">SET</span> login_count <span class="hljs-operator">=</span> user_stats.login_count <span class="hljs-operator">+</span> <span class="hljs-number">1</span>;
</code></pre>
<h2>Monitoring and Troubleshooting</h2>
<h3>Check Current Transactions</h3>
<pre><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span>
    pid,
    usename,
    application_name,
    state,
    query_start,
    state_change,
    query
<span class="hljs-keyword">FROM</span> pg_stat_activity
<span class="hljs-keyword">WHERE</span> state <span class="hljs-operator">!=</span> <span class="hljs-string">'idle'</span>;
</code></pre>
<h3>Find Blocking Queries</h3>
<pre><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span>
    blocked_locks.pid <span class="hljs-keyword">AS</span> blocked_pid,
    blocked_activity.usename <span class="hljs-keyword">AS</span> blocked_user,
    blocking_locks.pid <span class="hljs-keyword">AS</span> blocking_pid,
    blocking_activity.usename <span class="hljs-keyword">AS</span> blocking_user,
    blocked_activity.query <span class="hljs-keyword">AS</span> blocked_statement,
    blocking_activity.query <span class="hljs-keyword">AS</span> blocking_statement
<span class="hljs-keyword">FROM</span> pg_catalog.pg_locks blocked_locks
<span class="hljs-keyword">JOIN</span> pg_catalog.pg_stat_activity blocked_activity <span class="hljs-keyword">ON</span> blocked_activity.pid <span class="hljs-operator">=</span> blocked_locks.pid
<span class="hljs-keyword">JOIN</span> pg_catalog.pg_locks blocking_locks
    <span class="hljs-keyword">ON</span> blocking_locks.locktype <span class="hljs-operator">=</span> blocked_locks.locktype
    <span class="hljs-keyword">AND</span> blocking_locks.database <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> blocked_locks.database
    <span class="hljs-keyword">AND</span> blocking_locks.relation <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> blocked_locks.relation
    <span class="hljs-keyword">AND</span> blocking_locks.page <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> blocked_locks.page
    <span class="hljs-keyword">AND</span> blocking_locks.tuple <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> blocked_locks.tuple
    <span class="hljs-keyword">AND</span> blocking_locks.virtualxid <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> blocked_locks.virtualxid
    <span class="hljs-keyword">AND</span> blocking_locks.transactionid <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> blocked_locks.transactionid
    <span class="hljs-keyword">AND</span> blocking_locks.classid <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> blocked_locks.classid
    <span class="hljs-keyword">AND</span> blocking_locks.objid <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> blocked_locks.objid
    <span class="hljs-keyword">AND</span> blocking_locks.objsubid <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> blocked_locks.objsubid
    <span class="hljs-keyword">AND</span> blocking_locks.pid <span class="hljs-operator">!=</span> blocked_locks.pid
<span class="hljs-keyword">JOIN</span> pg_catalog.pg_stat_activity blocking_activity <span class="hljs-keyword">ON</span> blocking_activity.pid <span class="hljs-operator">=</span> blocking_locks.pid
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">NOT</span> blocked_locks.granted;
</code></pre>
<h3>View Lock Information</h3>
<pre><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span>
    locktype,
    relation::regclass,
    mode,
    granted,
    pid
<span class="hljs-keyword">FROM</span> pg_locks
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">NOT</span> granted;
</code></pre>
<h3>Enable Query Logging</h3>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Log long-running queries</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> log_min_duration_statement <span class="hljs-operator">=</span> <span class="hljs-string">'1000'</span>; <span class="hljs-comment">-- 1 second</span>

<span class="hljs-comment">-- Log lock waits</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> log_lock_waits <span class="hljs-operator">=</span> <span class="hljs-keyword">on</span>;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> deadlock_timeout <span class="hljs-operator">=</span> <span class="hljs-string">'1s'</span>;

<span class="hljs-comment">-- Apply changes</span>
<span class="hljs-keyword">SELECT</span> pg_reload_conf();
</code></pre>
<h2>Performance Considerations</h2>
<h3>Transaction ID Wraparound</h3>
<p>PostgreSQL uses 32-bit transaction IDs that can wrap around. Regular VACUUM prevents this:</p>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Check age of oldest transaction</span>
<span class="hljs-keyword">SELECT</span> datname, age(datfrozenxid)
<span class="hljs-keyword">FROM</span> pg_database
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> age(datfrozenxid) <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- Warning occurs at 200 million, emergency at 2 billion</span>
</code></pre>
<h3>Bloat from Long Transactions</h3>
<p>Long transactions prevent VACUUM from cleaning up old row versions:</p>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- Check table bloat</span>
<span class="hljs-keyword">SELECT</span>
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname<span class="hljs-operator">||</span><span class="hljs-string">'.'</span><span class="hljs-operator">||</span>tablename)) <span class="hljs-keyword">AS</span> size,
    n_dead_tup
<span class="hljs-keyword">FROM</span> pg_stat_user_tables
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> n_dead_tup <span class="hljs-keyword">DESC</span>;
</code></pre>
<h3>Index-Only Scans</h3>
<p>Ensure visibility map is updated for better performance:</p>
<pre><code class="hljs language-sql">VACUUM ANALYZE your_table;
</code></pre>
<h2>Conclusion</h2>
<p>Understanding transactions and isolation levels in PostgreSQL is essential for building reliable, concurrent applications. Key takeaways:</p>
<ul>
  <li>Use the default Read Committed isolation level for most operations</li>
  <li>Keep transactions short to minimize locking and bloat</li>
  <li>Implement retry logic for serialization failures at higher isolation levels</li>
  <li>Leverage MVCC and avoid unnecessary explicit locking</li>
  <li>Monitor long-running transactions and blocking queries</li>
  <li>Use appropriate patterns like SKIP LOCKED for queue processing</li>
</ul>
<p>PostgreSQL's sophisticated transaction system provides excellent tools for maintaining data consistency while achieving high concurrency. By understanding these mechanisms and following best practices, you can build robust applications that handle concurrent access gracefully.</p>
</article></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"noteKey":["databases","concurrency-and-locks"],"note":{"title":"SQL Databases Concurrency And Locks","date":"2025-10-17","content":"\n\u003ch2\u003eIntroduction\u003c/h2\u003e\n\u003cp\u003eTransactions are fundamental building blocks of database systems that ensure data integrity and consistency. In PostgreSQL, understanding how transactions work and how different isolation levels affect concurrent operations is crucial for building reliable applications.\u003c/p\u003e\n\u003cp\u003eThis guide explores PostgreSQL's transaction model, isolation levels, concurrency control mechanisms, and best practices for handling transactions in production environments.\u003c/p\u003e\n\u003ch2\u003eWhat is a Transaction?\u003c/h2\u003e\n\u003cp\u003eA transaction is a sequence of one or more SQL operations that are treated as a single unit of work. Transactions follow the ACID properties:\u003c/p\u003e\n\u003cul\u003e\n  \u003cli\u003e\u003cstrong\u003eAtomicity\u003c/strong\u003e: All operations in a transaction succeed or all fail together\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003eConsistency\u003c/strong\u003e: Transactions move the database from one valid state to another\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003eIsolation\u003c/strong\u003e: Concurrent transactions don't interfere with each other\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003eDurability\u003c/strong\u003e: Once committed, changes persist even after system failures\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eBasic Transaction Commands\u003c/h2\u003e\n\u003ch3\u003eStarting and Ending Transactions\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Begin a transaction\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e-- Perform operations\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e+\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e-- Commit the transaction\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eCOMMIT\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eRolling Back Transactions\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e-- Something went wrong, undo everything\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eROLLBACK\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eSavepoints\u003c/h3\u003e\n\u003cp\u003eSavepoints allow you to partially rollback a transaction:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eSAVEPOINT\u003c/span\u003e my_savepoint;\n\n\u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e+\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e-- Rollback only to the savepoint\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eROLLBACK\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eTO\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eSAVEPOINT\u003c/span\u003e my_savepoint;\n\n\u003cspan class=\"hljs-comment\"\u003e-- The first UPDATE is still active\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eCOMMIT\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eIsolation Levels\u003c/h2\u003e\n\u003cp\u003ePostgreSQL implements four standard SQL isolation levels, each providing different guarantees about what phenomena can occur when transactions run concurrently.\u003c/p\u003e\n\u003ch3\u003eRead Phenomena\u003c/h3\u003e\n\u003cp\u003eBefore discussing isolation levels, it's important to understand the read phenomena they prevent:\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eDirty Read\u003c/strong\u003e: Reading uncommitted changes from another transaction\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eNon-Repeatable Read\u003c/strong\u003e: Reading the same row twice in a transaction and getting different values because another transaction modified and committed the row\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003ePhantom Read\u003c/strong\u003e: Re-executing a query and finding rows that weren't there before because another transaction inserted and committed new rows\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eSerialization Anomaly\u003c/strong\u003e: The result of successfully committing a group of transactions is inconsistent with all possible orderings of running those transactions one at a time\u003c/p\u003e\n\u003ch3\u003ePostgreSQL Isolation Levels\u003c/h3\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n    \u003ctr\u003e\n      \u003cth\u003eIsolation Level\u003c/th\u003e\n      \u003cth\u003eDirty Read\u003c/th\u003e\n      \u003cth\u003eNon-Repeatable Read\u003c/th\u003e\n      \u003cth\u003ePhantom Read\u003c/th\u003e\n      \u003cth\u003eSerialization Anomaly\u003c/th\u003e\n    \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n    \u003ctr\u003e\n      \u003ctd\u003eRead Uncommitted\u003c/td\u003e\n      \u003ctd\u003eNot possible*\u003c/td\u003e\n      \u003ctd\u003ePossible\u003c/td\u003e\n      \u003ctd\u003ePossible\u003c/td\u003e\n      \u003ctd\u003ePossible\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd\u003eRead Committed\u003c/td\u003e\n      \u003ctd\u003eNot possible\u003c/td\u003e\n      \u003ctd\u003ePossible\u003c/td\u003e\n      \u003ctd\u003ePossible\u003c/td\u003e\n      \u003ctd\u003ePossible\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd\u003eRepeatable Read\u003c/td\u003e\n      \u003ctd\u003eNot possible\u003c/td\u003e\n      \u003ctd\u003eNot possible\u003c/td\u003e\n      \u003ctd\u003eNot possible**\u003c/td\u003e\n      \u003ctd\u003ePossible\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd\u003eSerializable\u003c/td\u003e\n      \u003ctd\u003eNot possible\u003c/td\u003e\n      \u003ctd\u003eNot possible\u003c/td\u003e\n      \u003ctd\u003eNot possible\u003c/td\u003e\n      \u003ctd\u003eNot possible\u003c/td\u003e\n    \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e*PostgreSQL treats Read Uncommitted as Read Committed\u003cbr\u003e**PostgreSQL prevents phantom reads at Repeatable Read level\u003c/p\u003e\n\u003ch3\u003eRead Committed (Default)\u003c/h3\u003e\n\u003cp\u003eThis is PostgreSQL's default isolation level. Each query within a transaction sees a snapshot of the database as of the start of that query.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Session 1\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e balance \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n\u003cspan class=\"hljs-comment\"\u003e-- Returns 1000\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Session 2\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1500\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eCOMMIT\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Session 1 (continuing)\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e balance \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n\u003cspan class=\"hljs-comment\"\u003e-- Returns 1500 (sees the committed change)\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eCOMMIT\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eUse cases\u003c/strong\u003e: Most applications work well with Read Committed. It provides good performance while preventing dirty reads.\u003c/p\u003e\n\u003ch3\u003eRepeatable Read\u003c/h3\u003e\n\u003cp\u003eEach query in a transaction sees a snapshot of the database as of the start of the first query in that transaction.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Session 1\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e TRANSACTION ISOLATION LEVEL REPEATABLE READ;\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e balance \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n\u003cspan class=\"hljs-comment\"\u003e-- Returns 1000\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Session 2\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1500\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eCOMMIT\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Session 1 (continuing)\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e balance \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n\u003cspan class=\"hljs-comment\"\u003e-- Still returns 1000 (doesn't see the committed change)\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eCOMMIT\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eUse cases\u003c/strong\u003e: Long-running reports, data exports, or any operation that needs a consistent view of data throughout the transaction.\u003c/p\u003e\n\u003ch3\u003eSerializable\u003c/h3\u003e\n\u003cp\u003eThe strictest isolation level. Transactions execute as if they ran one at a time, with no concurrency. PostgreSQL uses Serializable Snapshot Isolation (SSI) to implement this efficiently.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Session 1\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e TRANSACTION ISOLATION LEVEL SERIALIZABLE;\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003eSUM\u003c/span\u003e(balance) \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e type \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'checking'\u003c/span\u003e;\n\u003cspan class=\"hljs-comment\"\u003e-- Returns 10000\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Session 2\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e TRANSACTION ISOLATION LEVEL SERIALIZABLE;\n\u003cspan class=\"hljs-keyword\"\u003eINSERT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eINTO\u003c/span\u003e accounts (type, balance) \u003cspan class=\"hljs-keyword\"\u003eVALUES\u003c/span\u003e (\u003cspan class=\"hljs-string\"\u003e'checking'\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e500\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003eCOMMIT\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Session 1 (continuing)\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eINSERT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eINTO\u003c/span\u003e audit_log (total_checking)\n\u003cspan class=\"hljs-keyword\"\u003eVALUES\u003c/span\u003e ((\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003eSUM\u003c/span\u003e(balance) \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e type \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'checking'\u003c/span\u003e));\n\u003cspan class=\"hljs-comment\"\u003e-- ERROR: could not serialize access due to read/write dependencies\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eUse cases\u003c/strong\u003e: Financial systems, inventory management, or any scenario where serialization anomalies would cause data corruption.\u003c/p\u003e\n\u003ch3\u003eSetting Isolation Levels\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- For a single transaction\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e TRANSACTION ISOLATION LEVEL REPEATABLE READ;\n\n\u003cspan class=\"hljs-comment\"\u003e-- For the current session\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e SESSION CHARACTERISTICS \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e TRANSACTION ISOLATION LEVEL REPEATABLE READ;\n\n\u003cspan class=\"hljs-comment\"\u003e-- Using SET TRANSACTION\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e TRANSACTION ISOLATION LEVEL SERIALIZABLE;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eMulti-Version Concurrency Control (MVCC)\u003c/h2\u003e\n\u003cp\u003ePostgreSQL uses MVCC to implement isolation levels efficiently. Instead of locking rows, it maintains multiple versions of data:\u003c/p\u003e\n\u003cul\u003e\n  \u003cli\u003eWhen a row is updated, PostgreSQL creates a new version rather than overwriting the old one\u003c/li\u003e\n  \u003cli\u003eEach transaction sees the appropriate version based on its isolation level and start time\u003c/li\u003e\n  \u003cli\u003eOld versions are cleaned up by the VACUUM process\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eBenefits of MVCC\u003c/h3\u003e\n\u003cul\u003e\n  \u003cli\u003eReaders don't block writers\u003c/li\u003e\n  \u003cli\u003eWriters don't block readers\u003c/li\u003e\n  \u003cli\u003eHigh concurrency with minimal locking\u003c/li\u003e\n  \u003cli\u003eNo dirty reads\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eTransaction IDs\u003c/h3\u003e\n\u003cp\u003eEvery transaction receives a unique transaction ID (XID). Each row version is tagged with XIDs indicating when it was created and deleted:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- View transaction IDs (requires superuser or appropriate permissions)\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e txid_current();\n\n\u003cspan class=\"hljs-comment\"\u003e-- See row versions (for debugging)\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e xmin, xmax, \u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e accounts;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eLocking in PostgreSQL\u003c/h2\u003e\n\u003cp\u003eWhile MVCC reduces the need for locks, PostgreSQL still uses locks for certain operations.\u003c/p\u003e\n\u003ch3\u003eLock Modes\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eTable-Level Locks\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n  \u003cli\u003eACCESS SHARE: Acquired by SELECT\u003c/li\u003e\n  \u003cli\u003eROW SHARE: Acquired by SELECT FOR UPDATE\u003c/li\u003e\n  \u003cli\u003eROW EXCLUSIVE: Acquired by UPDATE, DELETE, INSERT\u003c/li\u003e\n  \u003cli\u003eSHARE UPDATE EXCLUSIVE: Acquired by VACUUM, CREATE INDEX CONCURRENTLY\u003c/li\u003e\n  \u003cli\u003eSHARE: Acquired by CREATE INDEX\u003c/li\u003e\n  \u003cli\u003eSHARE ROW EXCLUSIVE: Acquired by CREATE TRIGGER\u003c/li\u003e\n  \u003cli\u003eEXCLUSIVE: Blocks all concurrent access except ACCESS SHARE\u003c/li\u003e\n  \u003cli\u003eACCESS EXCLUSIVE: Acquired by DROP TABLE, TRUNCATE, REINDEX, VACUUM FULL\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eRow-Level Locks\u003c/strong\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Lock rows for update (blocks other locks)\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFOR\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e-- Lock rows but allow other shared locks\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFOR\u003c/span\u003e SHARE;\n\n\u003cspan class=\"hljs-comment\"\u003e-- Skip locked rows instead of waiting\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e queue \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e status \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'pending'\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eFOR\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eSKIP\u003c/span\u003e LOCKED LIMIT \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e-- Don't wait for locks, error immediately\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFOR\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e NOWAIT;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eAdvisory Locks\u003c/h3\u003e\n\u003cp\u003ePostgreSQL provides advisory locks for application-level coordination:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Session-level advisory lock\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e pg_advisory_lock(\u003cspan class=\"hljs-number\"\u003e12345\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e pg_advisory_unlock(\u003cspan class=\"hljs-number\"\u003e12345\u003c/span\u003e);\n\n\u003cspan class=\"hljs-comment\"\u003e-- Transaction-level advisory lock\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e pg_advisory_xact_lock(\u003cspan class=\"hljs-number\"\u003e12345\u003c/span\u003e);\n\u003cspan class=\"hljs-comment\"\u003e-- Automatically released at transaction end\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e-- Try lock without blocking\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e pg_try_advisory_lock(\u003cspan class=\"hljs-number\"\u003e12345\u003c/span\u003e);\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eHandling Deadlocks\u003c/h2\u003e\n\u003cp\u003eA deadlock occurs when transactions wait for each other in a cycle. PostgreSQL automatically detects and resolves deadlocks by aborting one transaction.\u003c/p\u003e\n\u003ch3\u003eExample Deadlock\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Session 1\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n\u003cspan class=\"hljs-comment\"\u003e-- Waiting to update id = 2\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Session 2\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e;\n\u003cspan class=\"hljs-comment\"\u003e-- Waiting to update id = 1\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e+\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n\u003cspan class=\"hljs-comment\"\u003e-- ERROR: deadlock detected\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003ePreventing Deadlocks\u003c/h3\u003e\n\u003cp\u003eAlways access resources in the same order across all transactions:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Good: consistent ordering\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e LEAST(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e+\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e GREATEST(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003eCOMMIT\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eUse timeouts:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Set statement timeout\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e statement_timeout \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'5s'\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e-- Set lock timeout\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e lock_timeout \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'2s'\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eSerialization Failures\u003c/h2\u003e\n\u003cp\u003eAt Repeatable Read and Serializable levels, transactions may fail with serialization errors:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-vbnet\"\u003e\u003cspan class=\"hljs-symbol\"\u003eERROR:\u003c/span\u003e could \u003cspan class=\"hljs-built_in\"\u003enot\u003c/span\u003e serialize access due \u003cspan class=\"hljs-keyword\"\u003eto\u003c/span\u003e concurrent update\n\u003cspan class=\"hljs-symbol\"\u003eERROR:\u003c/span\u003e could \u003cspan class=\"hljs-built_in\"\u003enot\u003c/span\u003e serialize access due \u003cspan class=\"hljs-keyword\"\u003eto\u003c/span\u003e read/write dependencies among transactions\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eHandling Serialization Errors\u003c/h3\u003e\n\u003cp\u003eAlways implement retry logic:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etransfer_money\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003efrom_id, to_id, amount\u003c/span\u003e):\n    max_retries = \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e attempt \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003erange\u003c/span\u003e(max_retries):\n        \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e:\n            \u003cspan class=\"hljs-keyword\"\u003ewith\u003c/span\u003e connection.cursor() \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e cur:\n                cur.execute(\u003cspan class=\"hljs-string\"\u003e\"BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE\"\u003c/span\u003e)\n                cur.execute(\n                    \u003cspan class=\"hljs-string\"\u003e\"UPDATE accounts SET balance = balance - %s WHERE id = %s\"\u003c/span\u003e,\n                    (amount, from_id)\n                )\n                cur.execute(\n                    \u003cspan class=\"hljs-string\"\u003e\"UPDATE accounts SET balance = balance + %s WHERE id = %s\"\u003c/span\u003e,\n                    (amount, to_id)\n                )\n                cur.execute(\u003cspan class=\"hljs-string\"\u003e\"COMMIT\"\u003c/span\u003e)\n                \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003eTrue\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003eexcept\u003c/span\u003e SerializationFailure:\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e attempt \u0026#x3C; max_retries - \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e:\n                time.sleep(\u003cspan class=\"hljs-number\"\u003e0.1\u003c/span\u003e * (\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e ** attempt))  \u003cspan class=\"hljs-comment\"\u003e# Exponential backoff\u003c/span\u003e\n                \u003cspan class=\"hljs-keyword\"\u003econtinue\u003c/span\u003e\n            \u003cspan class=\"hljs-keyword\"\u003eraise\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eTransaction Best Practices\u003c/h2\u003e\n\u003ch3\u003eKeep Transactions Short\u003c/h3\u003e\n\u003cp\u003eLong-running transactions hold locks, prevent VACUUM from cleaning old row versions, and increase the chance of conflicts:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Bad: transaction open while waiting for user input\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e products \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e123\u003c/span\u003e;\n\u003cspan class=\"hljs-comment\"\u003e-- Application waits for user to confirm\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e products \u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e quantity \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e quantity \u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e123\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eCOMMIT\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e-- Good: transaction only during database operations\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e*\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e products \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e123\u003c/span\u003e;\n\u003cspan class=\"hljs-comment\"\u003e-- Application waits for user to confirm\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e products \u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e quantity \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e quantity \u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e123\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eCOMMIT\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eUse Appropriate Isolation Levels\u003c/h3\u003e\n\u003cp\u003eDon't use stricter isolation than necessary:\u003c/p\u003e\n\u003cul\u003e\n  \u003cli\u003eUse Read Committed for most operations\u003c/li\u003e\n  \u003cli\u003eUse Repeatable Read for reports and data exports\u003c/li\u003e\n  \u003cli\u003eUse Serializable only when business logic requires it\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eHandle Errors Properly\u003c/h3\u003e\n\u003cp\u003eAlways handle transaction errors:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eSAVEPOINT\u003c/span\u003e before_risky_operation;\n\n\u003cspan class=\"hljs-comment\"\u003e-- Risky operation\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e balance \u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1000\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e-- Check constraint violation\u003c/span\u003e\nDO $$\n\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e\n    IF (\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e balance \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e) \u003cspan class=\"hljs-operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eTHEN\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003eROLLBACK\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eTO\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eSAVEPOINT\u003c/span\u003e before_risky_operation;\n        RAISE EXCEPTION \u003cspan class=\"hljs-string\"\u003e'Insufficient funds'\u003c/span\u003e;\n    \u003cspan class=\"hljs-keyword\"\u003eEND\u003c/span\u003e IF;\n\u003cspan class=\"hljs-keyword\"\u003eEND\u003c/span\u003e $$;\n\n\u003cspan class=\"hljs-keyword\"\u003eCOMMIT\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eUse Connection Pooling Wisely\u003c/h3\u003e\n\u003cp\u003eConnection pools can complicate transaction management:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-comment\"\u003e# Ensure transactions are completed before returning to pool\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e:\n    connection = pool.get_connection()\n    \u003cspan class=\"hljs-comment\"\u003e# Do work\u003c/span\u003e\n    connection.commit()\n\u003cspan class=\"hljs-keyword\"\u003eexcept\u003c/span\u003e Exception:\n    connection.rollback()\n    \u003cspan class=\"hljs-keyword\"\u003eraise\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efinally\u003c/span\u003e:\n    pool.return_connection(connection)\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eMonitor Transaction Age\u003c/h3\u003e\n\u003cp\u003eLong-running transactions cause problems. Monitor them:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    pid,\n    now() \u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003e xact_start \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e duration,\n    state,\n    query\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e pg_stat_activity\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e xact_start \u003cspan class=\"hljs-keyword\"\u003eIS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eNOT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eNULL\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e xact_start;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eAvoid Explicit Locking When Possible\u003c/h3\u003e\n\u003cp\u003eLet MVCC do its job. Only use explicit locks when necessary:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Usually unnecessary\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e;\nLOCK \u003cspan class=\"hljs-keyword\"\u003eTABLE\u003c/span\u003e accounts \u003cspan class=\"hljs-keyword\"\u003eIN\u003c/span\u003e EXCLUSIVE MODE;\n\u003cspan class=\"hljs-comment\"\u003e-- operations\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eCOMMIT\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e-- Better: let MVCC handle it\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e;\n\u003cspan class=\"hljs-comment\"\u003e-- operations\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eCOMMIT\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eCommon Patterns\u003c/h2\u003e\n\u003ch3\u003eOptimistic Locking with Version Columns\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eCREATE\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eTABLE\u003c/span\u003e documents (\n    id SERIAL \u003cspan class=\"hljs-keyword\"\u003ePRIMARY\u003c/span\u003e KEY,\n    content TEXT,\n    version \u003cspan class=\"hljs-type\"\u003eINTEGER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eDEFAULT\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n);\n\n\u003cspan class=\"hljs-comment\"\u003e-- Update with version check\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e documents\n\u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e content \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'new content'\u003c/span\u003e, version \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e version \u003cspan class=\"hljs-operator\"\u003e+\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e123\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e version \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e-- Check if update succeeded\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eGET\u003c/span\u003e DIAGNOSTICS rows_updated \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e ROW_COUNT;\nIF rows_updated \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eTHEN\u003c/span\u003e\n    RAISE EXCEPTION \u003cspan class=\"hljs-string\"\u003e'Document was modified by another user'\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eEND\u003c/span\u003e IF;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eQueue Processing with SKIP LOCKED\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Multiple workers can process queue concurrently\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e id \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e job_queue\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e status \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'pending'\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e created_at\n\u003cspan class=\"hljs-keyword\"\u003eFOR\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eSKIP\u003c/span\u003e LOCKED\nLIMIT \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e job_queue\n\u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e status \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'processing'\u003c/span\u003e, started_at \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e now()\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e\u0026#x3C;\u003c/span\u003eselected_id\u003cspan class=\"hljs-operator\"\u003e\u003e\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eCOMMIT\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e-- Process the job\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eBEGIN\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e job_queue\n\u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e status \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'completed'\u003c/span\u003e, completed_at \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e now()\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e id \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e\u0026#x3C;\u003c/span\u003eselected_id\u003cspan class=\"hljs-operator\"\u003e\u003e\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eCOMMIT\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eConditional Inserts\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Insert only if not exists\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eINSERT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eINTO\u003c/span\u003e users (email, name)\n\u003cspan class=\"hljs-keyword\"\u003eVALUES\u003c/span\u003e (\u003cspan class=\"hljs-string\"\u003e'user@example.com'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'John Doe'\u003c/span\u003e)\n\u003cspan class=\"hljs-keyword\"\u003eON\u003c/span\u003e CONFLICT (email) DO NOTHING;\n\n\u003cspan class=\"hljs-comment\"\u003e-- Insert or update\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eINSERT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eINTO\u003c/span\u003e user_stats (user_id, login_count)\n\u003cspan class=\"hljs-keyword\"\u003eVALUES\u003c/span\u003e (\u003cspan class=\"hljs-number\"\u003e123\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e)\n\u003cspan class=\"hljs-keyword\"\u003eON\u003c/span\u003e CONFLICT (user_id)\nDO \u003cspan class=\"hljs-keyword\"\u003eUPDATE\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e login_count \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e user_stats.login_count \u003cspan class=\"hljs-operator\"\u003e+\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eMonitoring and Troubleshooting\u003c/h2\u003e\n\u003ch3\u003eCheck Current Transactions\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    pid,\n    usename,\n    application_name,\n    state,\n    query_start,\n    state_change,\n    query\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e pg_stat_activity\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e state \u003cspan class=\"hljs-operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'idle'\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eFind Blocking Queries\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    blocked_locks.pid \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e blocked_pid,\n    blocked_activity.usename \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e blocked_user,\n    blocking_locks.pid \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e blocking_pid,\n    blocking_activity.usename \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e blocking_user,\n    blocked_activity.query \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e blocked_statement,\n    blocking_activity.query \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e blocking_statement\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e pg_catalog.pg_locks blocked_locks\n\u003cspan class=\"hljs-keyword\"\u003eJOIN\u003c/span\u003e pg_catalog.pg_stat_activity blocked_activity \u003cspan class=\"hljs-keyword\"\u003eON\u003c/span\u003e blocked_activity.pid \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e blocked_locks.pid\n\u003cspan class=\"hljs-keyword\"\u003eJOIN\u003c/span\u003e pg_catalog.pg_locks blocking_locks\n    \u003cspan class=\"hljs-keyword\"\u003eON\u003c/span\u003e blocking_locks.locktype \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e blocked_locks.locktype\n    \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e blocking_locks.database \u003cspan class=\"hljs-keyword\"\u003eIS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eNOT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e blocked_locks.database\n    \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e blocking_locks.relation \u003cspan class=\"hljs-keyword\"\u003eIS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eNOT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e blocked_locks.relation\n    \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e blocking_locks.page \u003cspan class=\"hljs-keyword\"\u003eIS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eNOT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e blocked_locks.page\n    \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e blocking_locks.tuple \u003cspan class=\"hljs-keyword\"\u003eIS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eNOT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e blocked_locks.tuple\n    \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e blocking_locks.virtualxid \u003cspan class=\"hljs-keyword\"\u003eIS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eNOT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e blocked_locks.virtualxid\n    \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e blocking_locks.transactionid \u003cspan class=\"hljs-keyword\"\u003eIS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eNOT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e blocked_locks.transactionid\n    \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e blocking_locks.classid \u003cspan class=\"hljs-keyword\"\u003eIS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eNOT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e blocked_locks.classid\n    \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e blocking_locks.objid \u003cspan class=\"hljs-keyword\"\u003eIS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eNOT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e blocked_locks.objid\n    \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e blocking_locks.objsubid \u003cspan class=\"hljs-keyword\"\u003eIS\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eNOT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eDISTINCT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e blocked_locks.objsubid\n    \u003cspan class=\"hljs-keyword\"\u003eAND\u003c/span\u003e blocking_locks.pid \u003cspan class=\"hljs-operator\"\u003e!=\u003c/span\u003e blocked_locks.pid\n\u003cspan class=\"hljs-keyword\"\u003eJOIN\u003c/span\u003e pg_catalog.pg_stat_activity blocking_activity \u003cspan class=\"hljs-keyword\"\u003eON\u003c/span\u003e blocking_activity.pid \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e blocking_locks.pid\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eNOT\u003c/span\u003e blocked_locks.granted;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eView Lock Information\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    locktype,\n    relation::regclass,\n    mode,\n    granted,\n    pid\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e pg_locks\n\u003cspan class=\"hljs-keyword\"\u003eWHERE\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eNOT\u003c/span\u003e granted;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eEnable Query Logging\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Log long-running queries\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eALTER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eSYSTEM\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e log_min_duration_statement \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'1000'\u003c/span\u003e; \u003cspan class=\"hljs-comment\"\u003e-- 1 second\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e-- Log lock waits\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eALTER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eSYSTEM\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e log_lock_waits \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eon\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eALTER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eSYSTEM\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eSET\u003c/span\u003e deadlock_timeout \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'1s'\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e-- Apply changes\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e pg_reload_conf();\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003ePerformance Considerations\u003c/h2\u003e\n\u003ch3\u003eTransaction ID Wraparound\u003c/h3\u003e\n\u003cp\u003ePostgreSQL uses 32-bit transaction IDs that can wrap around. Regular VACUUM prevents this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Check age of oldest transaction\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e datname, age(datfrozenxid)\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e pg_database\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e age(datfrozenxid) \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e-- Warning occurs at 200 million, emergency at 2 billion\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eBloat from Long Transactions\u003c/h3\u003e\n\u003cp\u003eLong transactions prevent VACUUM from cleaning up old row versions:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003e\u003cspan class=\"hljs-comment\"\u003e-- Check table bloat\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eSELECT\u003c/span\u003e\n    schemaname,\n    tablename,\n    pg_size_pretty(pg_total_relation_size(schemaname\u003cspan class=\"hljs-operator\"\u003e||\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e'.'\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e||\u003c/span\u003etablename)) \u003cspan class=\"hljs-keyword\"\u003eAS\u003c/span\u003e size,\n    n_dead_tup\n\u003cspan class=\"hljs-keyword\"\u003eFROM\u003c/span\u003e pg_stat_user_tables\n\u003cspan class=\"hljs-keyword\"\u003eORDER\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eBY\u003c/span\u003e n_dead_tup \u003cspan class=\"hljs-keyword\"\u003eDESC\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eIndex-Only Scans\u003c/h3\u003e\n\u003cp\u003eEnsure visibility map is updated for better performance:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sql\"\u003eVACUUM ANALYZE your_table;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eConclusion\u003c/h2\u003e\n\u003cp\u003eUnderstanding transactions and isolation levels in PostgreSQL is essential for building reliable, concurrent applications. Key takeaways:\u003c/p\u003e\n\u003cul\u003e\n  \u003cli\u003eUse the default Read Committed isolation level for most operations\u003c/li\u003e\n  \u003cli\u003eKeep transactions short to minimize locking and bloat\u003c/li\u003e\n  \u003cli\u003eImplement retry logic for serialization failures at higher isolation levels\u003c/li\u003e\n  \u003cli\u003eLeverage MVCC and avoid unnecessary explicit locking\u003c/li\u003e\n  \u003cli\u003eMonitor long-running transactions and blocking queries\u003c/li\u003e\n  \u003cli\u003eUse appropriate patterns like SKIP LOCKED for queue processing\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ePostgreSQL's sophisticated transaction system provides excellent tools for maintaining data consistency while achieving high concurrency. By understanding these mechanisms and following best practices, you can build robust applications that handle concurrent access gracefully.\u003c/p\u003e\n"}},"__N_SSG":true},"page":"/notes/[...noteKey]","query":{"noteKey":["databases","concurrency-and-locks"]},"buildId":"6V8_yxN3djhrhbRemYkax","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>