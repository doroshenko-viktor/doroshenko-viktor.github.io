<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Efficient Serialization Of Large Object Into JSON In C#</title><link rel="icon" href="/images/favicon.ico"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/b65b5b41f2379875.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b65b5b41f2379875.css" data-n-g=""/><link rel="preload" href="/_next/static/css/0d9654b911e08999.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0d9654b911e08999.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-fc97f3f1282ce3ed.js" defer=""></script><script src="/_next/static/chunks/main-f4ae3437c92c1efc.js" defer=""></script><script src="/_next/static/chunks/pages/_app-85d7488a393e293e.js" defer=""></script><script src="/_next/static/chunks/211-ca3cd870e26e881a.js" defer=""></script><script src="/_next/static/chunks/pages/notes/%5B...noteKey%5D-bc6552c3ae1e3718.js" defer=""></script><script src="/_next/static/IjqNhIRqaAJaH2DY5dkbz/_buildManifest.js" defer=""></script><script src="/_next/static/IjqNhIRqaAJaH2DY5dkbz/_ssgManifest.js" defer=""></script><script src="/_next/static/IjqNhIRqaAJaH2DY5dkbz/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><section class="Layout_centeredSection__nmU9U"><ul class="NavigationBar_navbar__CBMoV"><li class="NavigationBar_navitem__LKB5F"><a class="NavigationBar_navitemContent__jEyWq" href="/">Home</a><span class="NavigationBar_separator__qvEVD">|</span></li><li class="NavigationBar_navitem__LKB5F"><button class="NavigationBar_navitemContent__jEyWq">Back</button><span class="NavigationBar_separator__qvEVD">|</span></li></ul><h1 class="NoteFormattedContent_noteTitle__Oi9sD">Efficient Serialization Of Large Object Into JSON In C#</h1><article class="NoteFormattedContent_note__8cHeE">
<p>
  When you need to serialize large objects there may occur problems with memory allocation, heavy
  large object heap allocation which creates additional load on garbage collection and in some cases
  to throwing of <code>OutOfMemoryException</code>.
</p>
<p>
  Using <code>Newtonsoft.Json</code> package it is possible to serialize/deserialize large objects without loading
  whole data into memory.
</p>
<p>Let's consider an example. We have an object of simple structure:</p>
<pre><code class="hljs language-csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">record</span> <span class="hljs-keyword">struct</span> <span class="hljs-title">StreamedObject</span>(<span class="hljs-params">Guid Id, <span class="hljs-built_in">string</span> Value</span>)</span>;
</code></pre>
<p>
  And we have a large stream of such an objects with unknown length. It may be <code>gRPC</code>, simple iterator,
  making calls to external api or generated data. This objects eventually must be serialized
  into single <code>JSON</code> string and saved into file. To achieve this without a need to load all objects
  into memory in <code>Newtonsoft.Json</code> there is an overload of <code>Serialize</code> method of <code>JsonSerializer</code>,
  allowing to write data into stream as it appears:
</p>
<pre><code class="hljs language-csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Serialize</span>(<span class="hljs-params">JsonWriter jsonWriter, <span class="hljs-built_in">object</span>? <span class="hljs-keyword">value</span></span>)</span>;
</code></pre>
<p>
  Let's create a method, which will receive a stream and enumeration of our objects.
  This method will serialize objects by the way these objects appear directly into given stream:
</p>
<pre><code class="hljs language-csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">WriteJsonToStream</span>(<span class="hljs-params">Stream stream, IEnumerable&#x3C;StreamedObject> objects</span>)</span>
{
    <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> utcStreamWriter = <span class="hljs-keyword">new</span> StreamWriter(stream); <span class="hljs-comment">// create a UTF-8 encoded stream</span>
    <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> jsonWriter = <span class="hljs-keyword">new</span> JsonTextWriter(utcStreamWriter); <span class="hljs-comment">// create JsonWriter of Newtonsoft.Json</span>

    <span class="hljs-keyword">var</span> serializer = <span class="hljs-keyword">new</span> JsonSerializer();
    serializer.Serialize(jsonWriter, objects);
}
</code></pre>
<p>In preference it is handy to convert it into an extension method of <code>Stream</code>:</p>
<pre><code class="hljs language-csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">StreamExtensions</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WriteJsonToStream</span>&#x3C;<span class="hljs-title">T</span>>(<span class="hljs-params"><span class="hljs-keyword">this</span> Stream stream, IEnumerable&#x3C;T> objects</span>)</span>
    {
        <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> utcStreamWriter = <span class="hljs-keyword">new</span> StreamWriter(stream);
        <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> jsonWriter = <span class="hljs-keyword">new</span> JsonTextWriter(utcStreamWriter);

        <span class="hljs-keyword">var</span> serializer = <span class="hljs-keyword">new</span> JsonSerializer();
        serializer.Serialize(jsonWriter, objects);
    }
}
</code></pre>
<p>Now we can use this extension on some particular example:</p>
<pre><code class="hljs language-csharp"><span class="hljs-keyword">var</span> fixture = <span class="hljs-keyword">new</span> Fixture();
<span class="hljs-keyword">var</span> objects = fixture.CreateMany&#x3C;StreamedObject>(<span class="hljs-number">200</span>); <span class="hljs-comment">// create an enumeration of objects with length 200</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> file = File.Create(<span class="hljs-string">"test.json"</span>); <span class="hljs-comment">// create a file in local file system and get a stream,</span>
<span class="hljs-comment">// allowing to write into this file</span>

file.WriteJsonToStream(objects); <span class="hljs-comment">// serializing generated objects into file stream</span>
</code></pre>
<p>
  As we created an extension over simple stream, we are not limited with only <code>FileStream</code>.
  We can use it with any stream we may need:
</p>
<pre><code class="hljs language-csharp"><span class="hljs-comment">//..</span>
<span class="hljs-keyword">var</span> memoryStream = <span class="hljs-keyword">new</span> MemoryStream();
memoryStream.WriteJsonToStream(objects);
</code></pre>
<h2>References</h2>
<ul>
  <li><a href="https://www.newtonsoft.com/json/help/html/T_Newtonsoft_Json_JsonTextWriter.htm">https://www.newtonsoft.com/json/help/html/T_Newtonsoft_Json_JsonTextWriter.htm</a></li>
  <li><a href="https://www.newtonsoft.com/json/help/html/T_Newtonsoft_Json_JsonWriter.htm">https://www.newtonsoft.com/json/help/html/T_Newtonsoft_Json_JsonWriter.htm</a></li>
  <li><a href="https://www.newtonsoft.com/json/help/html/Performance.htm">https://www.newtonsoft.com/json/help/html/Performance.htm</a></li>
</ul>
</article></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"noteKey":["csharp","streaming-json-serialization"],"note":{"title":"Efficient Serialization Of Large Object Into JSON In C#","date":"2022-06-14","content":"\n\u003cp\u003e\n  When you need to serialize large objects there may occur problems with memory allocation, heavy\n  large object heap allocation which creates additional load on garbage collection and in some cases\n  to throwing of \u003ccode\u003eOutOfMemoryException\u003c/code\u003e.\n\u003c/p\u003e\n\u003cp\u003e\n  Using \u003ccode\u003eNewtonsoft.Json\u003c/code\u003e package it is possible to serialize/deserialize large objects without loading\n  whole data into memory.\n\u003c/p\u003e\n\u003cp\u003eLet's consider an example. We have an object of simple structure:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erecord\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eStreamedObject\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eGuid Id, \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e Value\u003c/span\u003e)\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\n  And we have a large stream of such an objects with unknown length. It may be \u003ccode\u003egRPC\u003c/code\u003e, simple iterator,\n  making calls to external api or generated data. This objects eventually must be serialized\n  into single \u003ccode\u003eJSON\u003c/code\u003e string and saved into file. To achieve this without a need to load all objects\n  into memory in \u003ccode\u003eNewtonsoft.Json\u003c/code\u003e there is an overload of \u003ccode\u003eSerialize\u003c/code\u003e method of \u003ccode\u003eJsonSerializer\u003c/code\u003e,\n  allowing to write data into stream as it appears:\n\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eSerialize\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eJsonWriter jsonWriter, \u003cspan class=\"hljs-built_in\"\u003eobject\u003c/span\u003e? \u003cspan class=\"hljs-keyword\"\u003evalue\u003c/span\u003e\u003c/span\u003e)\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\n  Let's create a method, which will receive a stream and enumeration of our objects.\n  This method will serialize objects by the way these objects appear directly into given stream:\n\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eWriteJsonToStream\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eStream stream, IEnumerable\u0026#x3C;StreamedObject\u003e objects\u003c/span\u003e)\u003c/span\u003e\n{\n    \u003cspan class=\"hljs-keyword\"\u003eusing\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e utcStreamWriter = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e StreamWriter(stream); \u003cspan class=\"hljs-comment\"\u003e// create a UTF-8 encoded stream\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003eusing\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e jsonWriter = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e JsonTextWriter(utcStreamWriter); \u003cspan class=\"hljs-comment\"\u003e// create JsonWriter of Newtonsoft.Json\u003c/span\u003e\n\n    \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e serializer = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e JsonSerializer();\n    serializer.Serialize(jsonWriter, objects);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn preference it is handy to convert it into an extension method of \u003ccode\u003eStream\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eStreamExtensions\u003c/span\u003e\n{\n    \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eWriteJsonToStream\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title\"\u003eT\u003c/span\u003e\u003e(\u003cspan class=\"hljs-params\"\u003e\u003cspan class=\"hljs-keyword\"\u003ethis\u003c/span\u003e Stream stream, IEnumerable\u0026#x3C;T\u003e objects\u003c/span\u003e)\u003c/span\u003e\n    {\n        \u003cspan class=\"hljs-keyword\"\u003eusing\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e utcStreamWriter = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e StreamWriter(stream);\n        \u003cspan class=\"hljs-keyword\"\u003eusing\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e jsonWriter = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e JsonTextWriter(utcStreamWriter);\n\n        \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e serializer = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e JsonSerializer();\n        serializer.Serialize(jsonWriter, objects);\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow we can use this extension on some particular example:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e fixture = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e Fixture();\n\u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e objects = fixture.CreateMany\u0026#x3C;StreamedObject\u003e(\u003cspan class=\"hljs-number\"\u003e200\u003c/span\u003e); \u003cspan class=\"hljs-comment\"\u003e// create an enumeration of objects with length 200\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eusing\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e file = File.Create(\u003cspan class=\"hljs-string\"\u003e\"test.json\"\u003c/span\u003e); \u003cspan class=\"hljs-comment\"\u003e// create a file in local file system and get a stream,\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e// allowing to write into this file\u003c/span\u003e\n\nfile.WriteJsonToStream(objects); \u003cspan class=\"hljs-comment\"\u003e// serializing generated objects into file stream\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\n  As we created an extension over simple stream, we are not limited with only \u003ccode\u003eFileStream\u003c/code\u003e.\n  We can use it with any stream we may need:\n\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"hljs-comment\"\u003e//..\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e memoryStream = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e MemoryStream();\nmemoryStream.WriteJsonToStream(objects);\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eReferences\u003c/h2\u003e\n\u003cul\u003e\n  \u003cli\u003e\u003ca href=\"https://www.newtonsoft.com/json/help/html/T_Newtonsoft_Json_JsonTextWriter.htm\"\u003ehttps://www.newtonsoft.com/json/help/html/T_Newtonsoft_Json_JsonTextWriter.htm\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://www.newtonsoft.com/json/help/html/T_Newtonsoft_Json_JsonWriter.htm\"\u003ehttps://www.newtonsoft.com/json/help/html/T_Newtonsoft_Json_JsonWriter.htm\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://www.newtonsoft.com/json/help/html/Performance.htm\"\u003ehttps://www.newtonsoft.com/json/help/html/Performance.htm\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n"}},"__N_SSG":true},"page":"/notes/[...noteKey]","query":{"noteKey":["csharp","streaming-json-serialization"]},"buildId":"IjqNhIRqaAJaH2DY5dkbz","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>