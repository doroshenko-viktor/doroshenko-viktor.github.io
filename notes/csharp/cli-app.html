<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Creating C# CLI App</title><link rel="icon" href="/images/favicon.ico"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/b65b5b41f2379875.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b65b5b41f2379875.css" data-n-g=""/><link rel="preload" href="/_next/static/css/0d9654b911e08999.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0d9654b911e08999.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-fc97f3f1282ce3ed.js" defer=""></script><script src="/_next/static/chunks/main-f4ae3437c92c1efc.js" defer=""></script><script src="/_next/static/chunks/pages/_app-85d7488a393e293e.js" defer=""></script><script src="/_next/static/chunks/211-ca3cd870e26e881a.js" defer=""></script><script src="/_next/static/chunks/pages/notes/%5B...noteKey%5D-bc6552c3ae1e3718.js" defer=""></script><script src="/_next/static/rEbIxoA2O-xiW5DUZwlG8/_buildManifest.js" defer=""></script><script src="/_next/static/rEbIxoA2O-xiW5DUZwlG8/_ssgManifest.js" defer=""></script><script src="/_next/static/rEbIxoA2O-xiW5DUZwlG8/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><section class="Layout_centeredSection__nmU9U"><ul class="NavigationBar_navbar__CBMoV"><li class="NavigationBar_navitem__LKB5F"><a class="NavigationBar_navitemContent__jEyWq" href="/">Home</a><span class="NavigationBar_separator__qvEVD">|</span></li><li class="NavigationBar_navitem__LKB5F"><button class="NavigationBar_navitemContent__jEyWq">Back</button><span class="NavigationBar_separator__qvEVD">|</span></li></ul><h1 class="NoteFormattedContent_noteTitle__Oi9sD">Creating C# CLI App</h1><article class="NoteFormattedContent_note__8cHeE">
<h2>Initial Setup</h2>
<p>
  We will create a simple <code>c#</code> application which will be able to run conventional <code>CLI</code> interface with mandatory arguments and optional parameters. Our app will have simple logging, provided by <code>Serilog</code>
  and <code>CQRS</code> pattern with <code>MediatR</code>.
</p>
<p>At the beginning we need to create a new solution, <code>CLI</code> and <code>Business</code> projects:</p>
<pre><code class="hljs language-bash">dotnet new sln -o charp-cli-app
<span class="hljs-built_in">cd</span> charp-cli-app
dotnet new console -o CLI
dotnet new console -o Business
dotnet sln add CLI Business
</code></pre>
<p>
  Our project will have simple business and presentation layering, where <code>Business</code> is a stable component
  and presentational <code>CLI</code> project will depend on it. This means, we need to create references between projects:
</p>
<pre><code class="hljs language-bash">dotnet add ./CLI reference Business
</code></pre>
<p>This will create a reference inside <code>CLI/CLI.csproj</code> file:</p>
<pre><code class="hljs language-xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">ItemGroup</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">ProjectReference</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">"..\Business\Business.csproj"</span> /></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">ItemGroup</span>></span>
</code></pre>
<p>We created solution and two empty projects with proper references. Now we need to add external dependencies for our project.</p>
<p>In <code>CLI</code> project add:</p>
<ul>
  <li><code>Serilog</code> library for logging</li>
  <li><code>Serilog.Sinks.Console</code> allows to configure logging into terminal</li>
  <li><code>Serilog.Extensions.Logging</code> - it allows to use Serilog with standard <code>ILogger&#x3C;T></code> interface</li>
  <li><code>Microsoft.Extensions.CommandLineUtils</code> NuGet to easily parse arguments and create commands</li>
</ul>
<pre><code class="hljs language-bash">dotnet add ./CLI package Serilog -v &#x3C;version>
dotnet add ./CLI package Serilog.Sinks.Console -v &#x3C;version>
dotnet add ./CLI package Serilog.Extensions.Logging -v &#x3C;version>
dotnet add ./CLI package Microsoft.Extensions.CommandLineUtils -v &#x3C;version>
</code></pre>
<p>This will create in <code>CLI/CLI.csproj</code> file following lines:</p>
<pre><code class="hljs language-xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">ItemGroup</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">PackageReference</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">"Microsoft.Extensions.CommandLineUtils"</span> <span class="hljs-attr">Version</span>=<span class="hljs-string">"&#x3C;version>"</span> /></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">PackageReference</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">"Serilog"</span> <span class="hljs-attr">Version</span>=<span class="hljs-string">"&#x3C;version>"</span> /></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">PackageReference</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">"Serilog.Extensions.Logging"</span> <span class="hljs-attr">Version</span>=<span class="hljs-string">"&#x3C;version>"</span> /></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">PackageReference</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">"Serilog.Sinks.Console"</span> <span class="hljs-attr">Version</span>=<span class="hljs-string">"&#x3C;version>"</span> /></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">ItemGroup</span>></span>
</code></pre>
<p>Then add to <code>Business</code>:</p>
<ul>
  <li><code>MediatR</code> - simple request/response library</li>
  <li><code>Microsoft.Extensions.Logging</code> - contains standard logging functionality, which we will use for <code>DI</code></li>
</ul>
<pre><code class="hljs language-bash">dotnet add ./Business package MediatR -v &#x3C;version>
dotnet add ./Business Microsoft.Extensions.Logging -v &#x3C;version>
</code></pre>
<pre><code class="hljs language-xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">ItemGroup</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">PackageReference</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">"MediatR"</span> <span class="hljs-attr">Version</span>=<span class="hljs-string">"&#x3C;version>"</span> /></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">PackageReference</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">"Microsoft.Extensions.Logging"</span> <span class="hljs-attr">Version</span>=<span class="hljs-string">"&#x3C;version>"</span> /></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">ItemGroup</span>></span>
</code></pre>
<p><em>Need to specify particular version of packages instead of , because it is always a subject to change</em></p>
<h2>Implementing Business</h2>
<p>
  Unlike real life in our study cli app business does not have a big value. To imitate it we simply will
  use basic mathematical operations.
</p>
<p>To be more conventional and a little bit follow TDD, create new test project:</p>
<pre><code class="hljs language-bash">dotnet new xunit -o Tests
dotnet add ./Tests reference ./Business
dotnet sln add Tests
</code></pre>
<p>And create new class <code>CalculatorTests</code> in tests project and create simple tests for our business:</p>
<pre><code class="hljs language-csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CalculatorTests</span>
{
    [<span class="hljs-meta">Theory</span>]
    [<span class="hljs-meta">InlineData(2, 1, 3)</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ShouldAddTwoValues__WhenNoOverflow</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> x, <span class="hljs-built_in">int</span> y, <span class="hljs-built_in">int</span> expectedResult</span>)</span>
    {
        <span class="hljs-comment">// arrange</span>
        <span class="hljs-keyword">var</span> calculator = <span class="hljs-keyword">new</span> Calculator();
        <span class="hljs-comment">// act</span>
        <span class="hljs-keyword">var</span> result = calculator.Add(x, y);
        <span class="hljs-comment">// assert</span>
        result.Should().Be(expectedResult);
    }
}
</code></pre>
<p>In business project create two interfaces. First <code>ICalculator</code>:</p>
<pre><code class="hljs language-csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">Business</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ICalculator</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Add</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> x, <span class="hljs-built_in">int</span> y</span>)</span>;
}
</code></pre>
<p>
  And second <code>IFileService</code> - it will be used if optional parameter to save result into file will be
  passed:
</p>
<pre><code class="hljs language-csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">Business.Interfaces</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IFileService</span>
{
    <span class="hljs-function">Task <span class="hljs-title">SaveToFileAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> path, <span class="hljs-built_in">string</span> content</span>)</span>;
}
</code></pre>
<p>Then create implementation in <code>Business</code>:</p>
<pre><code class="hljs language-csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">Business</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Calculator</span> : <span class="hljs-title">ICalculator</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Add</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> x, <span class="hljs-built_in">int</span> y</span>)</span>
    {
        <span class="hljs-keyword">return</span> x + y;
    }
}
</code></pre>
<p>This is a quite naive implementation, but it's enough for our purpose of building CLI application 😜</p>
<p>
  Implementation of <code>IFileService</code> we'll create in <code>CLI/Services</code> because it is not strictly related to
  our business, but to infrastructure:
</p>
<pre><code class="hljs language-csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">CLI.Services</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FileService</span> : <span class="hljs-title">IFileService</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">SaveToFileAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> path, <span class="hljs-built_in">string</span> content</span>)</span>
    {
        <span class="hljs-keyword">if</span> (File.Exists(path))
        {
            <span class="hljs-keyword">await</span> File.AppendAllTextAsync(path, content, ct);
        }
        <span class="hljs-keyword">else</span>
        {
            <span class="hljs-keyword">await</span> File.WriteAllTextAsync(path, content, ct);
        }
    }
}
</code></pre>
<p>Now as our tests pass, we can move to implementation of our <code>CLI</code>.</p>
<h2>CLI Project Configuration</h2>
<p>
  At the beginning we have to create <code>DI</code> container and register our dependencies.
  To do it, write following in <code>CLI/Program.cs</code> file:
</p>
<pre><code class="hljs language-csharp"><span class="hljs-keyword">var</span> serviceProvider = <span class="hljs-keyword">new</span> ServiceCollection()
    .AddSingleton&#x3C;ICalculator, Calculator>()
    .AddSingleton&#x3C;IFileService, FileService>()
    .BuildServiceProvider();
</code></pre>
<p><strong>Configuring Logging:</strong></p>
<p>Create file <code>ConfigurationExtensions.cs</code> file in <code>CLI</code> project with content:</p>
<pre><code class="hljs language-csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">CLI</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConfigurationExtensions</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IServiceCollection <span class="hljs-title">AddSerilogLogging</span>(<span class="hljs-params"><span class="hljs-keyword">this</span> IServiceCollection services</span>)</span>
    {
        <span class="hljs-keyword">var</span> logger = <span class="hljs-keyword">new</span> LoggerConfiguration()
            .WriteTo.Console()
            .CreateLogger();

        services.AddLogging(builder =>
        {
            builder.SetMinimumLevel(LogLevel.Trace);
            builder.AddSerilog(logger, dispose: <span class="hljs-literal">true</span>);
        });

        <span class="hljs-keyword">return</span> services;
    }
}
</code></pre>
<p>
  This will setup logging with <code>Serilog</code> to console and allows to use loggers with dependency injection.
  Now we can use this extension on our <code>DI</code> container in <code>Program.cs</code>:
</p>
<pre><code class="hljs language-csharp"><span class="hljs-keyword">var</span> serviceProvider = <span class="hljs-keyword">new</span> ServiceCollection()
    .AddSerilogLogging()
    .AddSingleton&#x3C;ICalculator, Calculator>()
    .AddSingleton&#x3C;IFileService, FileService>()
    .BuildServiceProvider();
</code></pre>
<p><strong>MediatR:</strong></p>
<p>Now creating <code>MediatR</code> command for adding numbers in <code>Business/Requests</code> folder:</p>
<pre><code class="hljs language-csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">Business.Requests</span>;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title">AddNumbersCommand</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> X, <span class="hljs-built_in">int</span> Y, <span class="hljs-built_in">string</span>? ResultPath</span>) : IRequest&#x3C;<span class="hljs-built_in">int</span>></span>
{ }
</code></pre>
<p>Command contains <code>nullable</code> ResultPath. If it exists we will save result to file by this provided path.</p>
<p>And handler for it in <code>Business/Handlers</code>:</p>
<pre><code class="hljs language-csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">Business.Handlers</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AddNumbersHandler</span> : <span class="hljs-title">IRequestHandler</span>&#x3C;<span class="hljs-title">AddNumbersCommand</span>>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ILogger&#x3C;AddNumbersHandler> _logger;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ICalculator _calculator;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IFileService _fileService;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AddNumbersHandler</span>(<span class="hljs-params">
        ILogger&#x3C;AddNumbersHandler> logger,
        ICalculator calculator,
        IFileService fileService
    </span>)</span>
    {
        _logger = logger;
        _calculator = calculator;
        _fileService = fileService;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&#x3C;Unit> <span class="hljs-title">Handle</span>(<span class="hljs-params">AddNumbersCommand request, CancellationToken ct</span>)</span>
    {
        <span class="hljs-keyword">var</span> (x, y, resultPath) = request;
        <span class="hljs-keyword">try</span>
        {
            _logger.LogInformation(<span class="hljs-string">"Adding values {X} and {Y}"</span>, x, y);
            <span class="hljs-keyword">var</span> result = _calculator.Add(x, y);
            _logger.LogInformation(<span class="hljs-string">"Calculated result: {Result}"</span>, result);

            <span class="hljs-keyword">if</span> (resultPath <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>)
            {
                _logger.LogInformation(<span class="hljs-string">"Saving result to file {Path}"</span>, resultPath);
                <span class="hljs-keyword">var</span> content = <span class="hljs-string">$"Adding <span class="hljs-subst">{x}</span> + <span class="hljs-subst">{y}</span> = <span class="hljs-subst">{result}</span>\n"</span>;
                <span class="hljs-keyword">await</span> _fileService.SaveToFileAsync(resultPath, content, ct);
                _logger.LogInformation(<span class="hljs-string">"Result saved"</span>);
            }

            <span class="hljs-keyword">return</span> Unit.Value;
        }
        <span class="hljs-keyword">catch</span> (Exception e)
        {
            _logger.LogError(e, <span class="hljs-string">"Error happened during handling addition of values {X} and {Y}"</span>, x, y);
            <span class="hljs-keyword">throw</span>;
        }
    }
}
</code></pre>
<p>To register <code>MediatR</code> with <code>DI</code> container add it to <code>ServiceProvider</code> configuration in <code>Program.cs</code>:</p>
<pre><code class="hljs language-csharp"><span class="hljs-keyword">var</span> serviceProvider = <span class="hljs-keyword">new</span> ServiceCollection()
    .AddSerilogLogging()
    .AddMediatR(<span class="hljs-keyword">typeof</span>(AddNumbersHandler).Assembly)
    .AddSingleton&#x3C;ICalculator, Calculator>()
    .AddSingleton&#x3C;IFileService, FileService>()
    .BuildServiceProvider();
</code></pre>
<h2>CLI</h2>
<p>
  Now we can start to create a main part of this guide - CLI parameters parsing and routing them to
  proper command handler.
</p>
<p>In <code>Program.cs</code> file add following code, which creates <code>Microsoft.Extensions.CommandLineUtils</code> app:</p>
<pre><code class="hljs language-csharp"><span class="hljs-keyword">var</span> app = <span class="hljs-keyword">new</span> CommandLineApplication();
app.Name = <span class="hljs-string">"CSharp CLI Application"</span>;
app.Description = <span class="hljs-string">"Simple C# console application"</span>;
app.HelpOption(<span class="hljs-string">"-h|--help"</span>);
</code></pre>
<p>Here we create command line app object, where define it's name, description and define command to get help.</p>
<p>Next we will configure <code>add numbers</code> command.</p>
<pre><code class="hljs language-csharp"><span class="hljs-keyword">var</span> mediator = serviceProvider.GetRequiredService&#x3C;IMediator>();
<span class="hljs-keyword">var</span> logger = serviceProvider.GetRequiredService&#x3C;ILogger&#x3C;Program>>();

app.Command(<span class="hljs-string">"add"</span>, (opt) =>
{
    <span class="hljs-keyword">var</span> x = opt.Argument(
        name: <span class="hljs-string">"&#x3C;x>"</span>,
        description: <span class="hljs-string">"first number"</span>
    );
    <span class="hljs-keyword">var</span> y = opt.Argument(
        name: <span class="hljs-string">"&#x3C;y>"</span>,
        description: <span class="hljs-string">"second number"</span>
    );
    <span class="hljs-keyword">var</span> resultPath = opt.Option(
        template: <span class="hljs-string">"-rp|--result-path"</span>,
        description: <span class="hljs-string">"file path to save result"</span>,
        CommandOptionType.SingleValue
    );
    opt.HelpOption(<span class="hljs-string">"-h|--help"</span>);

    opt.OnExecute(<span class="hljs-keyword">async</span> () =>
    {
        <span class="hljs-keyword">try</span>
        {
            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">int</span>.TryParse(x.Value, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> xInt))
            {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">$"first argument <span class="hljs-subst">{x.Value}</span> is not a number"</span>);
            }
            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">int</span>.TryParse(y.Value, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> yInt))
            {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">$"first argument <span class="hljs-subst">{y.Value}</span> is not a number"</span>);
            }

            <span class="hljs-keyword">var</span> command = <span class="hljs-keyword">new</span> AddNumbersCommand
            (
                X: xInt,
                Y: yInt,
                ResultPath: resultPath.Values.Count > <span class="hljs-number">0</span> ? resultPath.Values[<span class="hljs-number">0</span>] : <span class="hljs-literal">null</span>
            );
            <span class="hljs-keyword">await</span> mediator.Send(command);
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
        <span class="hljs-keyword">catch</span> (ArgumentException e)
        {
            logger.LogError(<span class="hljs-string">"Error happened: {Message}"</span>, e.Message);
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">catch</span> (Exception)
        {
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        }
    });
});

app.Execute(args);
</code></pre>
<p>Here with <code>app.Command()</code> we create command handler with name <code>add</code>. If we run <code>--help</code> command of our app(inside of <code>./CLI</code> project) we will see something like this:</p>
<pre><code class="hljs language-txt">$: dotnet run -- --help


Usage: CSharp CLI Application [options] [command]

Options:
  -h|--help  Show help information

Commands:
  add

Use "CSharp CLI Application [command] --help" for more information about a command.
</code></pre>
<p>Then inside of command handler delegate we define arguments - first and second numbers to add and optional parameters - file path to save result and define help option for <code>add</code> command.</p>
<p>
  And finally with <code>opt.OnExecute</code> we define handler function, which will be executed to handle <code>add</code> command.
  Inside of this handler we specify logic to parse arguments to their target types and handling of
  possible parsing errors. When we have parsed parameters, using <code>mediator</code> we route our data to
  proper <code>add numbers</code> handler.
</p>
<p>Running help for <code>add</code> command in our <code>CLI</code> project we will get following result:</p>
<pre><code class="hljs language-txt">$: dotnet run -- add --help


Usage: CSharp CLI Application add [arguments] [options]

Arguments:
  &#x3C;x>  first number
  &#x3C;y>  second number

Options:
  -rp|--result-path  file path to save result
  -h|--help          Show help information
</code></pre>
<p>Now we can test our app. Running it with valid data gives following:</p>
<pre><code class="hljs language-txt">$: dotnet run -- add 2 2

[23:10:46 INF] Adding values 2 and 2
[23:10:46 INF] Calculated result: 4
</code></pre>
<p>Running with optional file path for saving result:</p>
<pre><code class="hljs language-txt">$: dotnet run -- add 2 2 --result-path results.txt

[23:11:59 INF] Adding values 2 and 2
[23:11:59 INF] Calculated result: 4
[23:11:59 INF] Saving result to file results.txt
[23:11:59 INF] Result saved
</code></pre>
<p>And also file <code>results.txt</code> will be created with content:</p>
<pre><code class="hljs language-txt">Adding 2 + 2 = 4
</code></pre>
<p>If we provide not valid input for add:</p>
<pre><code class="hljs language-txt">$: dotnet run -- add 2 asf

[23:13:35 ERR] Error happened: Second argument asf is not a number
</code></pre>
<p>And if we provide command, that does not exist program will return an error:</p>
<pre><code class="hljs language-txt">$: dotnet run -- subtract 2 2

Specify --help for a list of available options and commands.
Unhandled exception. Microsoft.Extensions.CommandLineUtils.CommandParsingException: Unrecognized command or argument 'subtract'
   at Microsoft.Extensions.CommandLineUtils.CommandLineApplication.Execute(String[] args)
   at Program.&#x3C;Main>$(String[] args) in ./csharp-cli-app/CLI/Program.cs:line 78
</code></pre>
</article></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"noteKey":["csharp","cli-app"],"note":{"title":"Creating C# CLI App","date":"2022-03-27","content":"\n\u003ch2\u003eInitial Setup\u003c/h2\u003e\n\u003cp\u003e\n  We will create a simple \u003ccode\u003ec#\u003c/code\u003e application which will be able to run conventional \u003ccode\u003eCLI\u003c/code\u003e interface with mandatory arguments and optional parameters. Our app will have simple logging, provided by \u003ccode\u003eSerilog\u003c/code\u003e\n  and \u003ccode\u003eCQRS\u003c/code\u003e pattern with \u003ccode\u003eMediatR\u003c/code\u003e.\n\u003c/p\u003e\n\u003cp\u003eAt the beginning we need to create a new solution, \u003ccode\u003eCLI\u003c/code\u003e and \u003ccode\u003eBusiness\u003c/code\u003e projects:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003edotnet new sln -o charp-cli-app\n\u003cspan class=\"hljs-built_in\"\u003ecd\u003c/span\u003e charp-cli-app\ndotnet new console -o CLI\ndotnet new console -o Business\ndotnet sln add CLI Business\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\n  Our project will have simple business and presentation layering, where \u003ccode\u003eBusiness\u003c/code\u003e is a stable component\n  and presentational \u003ccode\u003eCLI\u003c/code\u003e project will depend on it. This means, we need to create references between projects:\n\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003edotnet add ./CLI reference Business\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis will create a reference inside \u003ccode\u003eCLI/CLI.csproj\u003c/code\u003e file:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eItemGroup\u003c/span\u003e\u003e\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eProjectReference\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eInclude\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"..\\Business\\Business.csproj\"\u003c/span\u003e /\u003e\u003c/span\u003e\n\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003eItemGroup\u003c/span\u003e\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe created solution and two empty projects with proper references. Now we need to add external dependencies for our project.\u003c/p\u003e\n\u003cp\u003eIn \u003ccode\u003eCLI\u003c/code\u003e project add:\u003c/p\u003e\n\u003cul\u003e\n  \u003cli\u003e\u003ccode\u003eSerilog\u003c/code\u003e library for logging\u003c/li\u003e\n  \u003cli\u003e\u003ccode\u003eSerilog.Sinks.Console\u003c/code\u003e allows to configure logging into terminal\u003c/li\u003e\n  \u003cli\u003e\u003ccode\u003eSerilog.Extensions.Logging\u003c/code\u003e - it allows to use Serilog with standard \u003ccode\u003eILogger\u0026#x3C;T\u003e\u003c/code\u003e interface\u003c/li\u003e\n  \u003cli\u003e\u003ccode\u003eMicrosoft.Extensions.CommandLineUtils\u003c/code\u003e NuGet to easily parse arguments and create commands\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003edotnet add ./CLI package Serilog -v \u0026#x3C;version\u003e\ndotnet add ./CLI package Serilog.Sinks.Console -v \u0026#x3C;version\u003e\ndotnet add ./CLI package Serilog.Extensions.Logging -v \u0026#x3C;version\u003e\ndotnet add ./CLI package Microsoft.Extensions.CommandLineUtils -v \u0026#x3C;version\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis will create in \u003ccode\u003eCLI/CLI.csproj\u003c/code\u003e file following lines:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eItemGroup\u003c/span\u003e\u003e\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003ePackageReference\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eInclude\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"Microsoft.Extensions.CommandLineUtils\"\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eVersion\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"\u0026#x3C;version\u003e\"\u003c/span\u003e /\u003e\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003ePackageReference\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eInclude\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"Serilog\"\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eVersion\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"\u0026#x3C;version\u003e\"\u003c/span\u003e /\u003e\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003ePackageReference\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eInclude\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"Serilog.Extensions.Logging\"\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eVersion\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"\u0026#x3C;version\u003e\"\u003c/span\u003e /\u003e\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003ePackageReference\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eInclude\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"Serilog.Sinks.Console\"\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eVersion\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"\u0026#x3C;version\u003e\"\u003c/span\u003e /\u003e\u003c/span\u003e\n\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003eItemGroup\u003c/span\u003e\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen add to \u003ccode\u003eBusiness\u003c/code\u003e:\u003c/p\u003e\n\u003cul\u003e\n  \u003cli\u003e\u003ccode\u003eMediatR\u003c/code\u003e - simple request/response library\u003c/li\u003e\n  \u003cli\u003e\u003ccode\u003eMicrosoft.Extensions.Logging\u003c/code\u003e - contains standard logging functionality, which we will use for \u003ccode\u003eDI\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003edotnet add ./Business package MediatR -v \u0026#x3C;version\u003e\ndotnet add ./Business Microsoft.Extensions.Logging -v \u0026#x3C;version\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eItemGroup\u003c/span\u003e\u003e\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003ePackageReference\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eInclude\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"MediatR\"\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eVersion\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"\u0026#x3C;version\u003e\"\u003c/span\u003e /\u003e\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003ePackageReference\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eInclude\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"Microsoft.Extensions.Logging\"\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eVersion\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"\u0026#x3C;version\u003e\"\u003c/span\u003e /\u003e\u003c/span\u003e\n\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003eItemGroup\u003c/span\u003e\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cem\u003eNeed to specify particular version of packages instead of , because it is always a subject to change\u003c/em\u003e\u003c/p\u003e\n\u003ch2\u003eImplementing Business\u003c/h2\u003e\n\u003cp\u003e\n  Unlike real life in our study cli app business does not have a big value. To imitate it we simply will\n  use basic mathematical operations.\n\u003c/p\u003e\n\u003cp\u003eTo be more conventional and a little bit follow TDD, create new test project:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003edotnet new xunit -o Tests\ndotnet add ./Tests reference ./Business\ndotnet sln add Tests\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd create new class \u003ccode\u003eCalculatorTests\u003c/code\u003e in tests project and create simple tests for our business:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"hljs-keyword\"\u003enamespace\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eTests\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eCalculatorTests\u003c/span\u003e\n{\n    [\u003cspan class=\"hljs-meta\"\u003eTheory\u003c/span\u003e]\n    [\u003cspan class=\"hljs-meta\"\u003eInlineData(2, 1, 3)\u003c/span\u003e]\n    \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eShouldAddTwoValues__WhenNoOverflow\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003cspan class=\"hljs-built_in\"\u003eint\u003c/span\u003e x, \u003cspan class=\"hljs-built_in\"\u003eint\u003c/span\u003e y, \u003cspan class=\"hljs-built_in\"\u003eint\u003c/span\u003e expectedResult\u003c/span\u003e)\u003c/span\u003e\n    {\n        \u003cspan class=\"hljs-comment\"\u003e// arrange\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e calculator = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e Calculator();\n        \u003cspan class=\"hljs-comment\"\u003e// act\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e result = calculator.Add(x, y);\n        \u003cspan class=\"hljs-comment\"\u003e// assert\u003c/span\u003e\n        result.Should().Be(expectedResult);\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn business project create two interfaces. First \u003ccode\u003eICalculator\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"hljs-keyword\"\u003enamespace\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eBusiness\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003einterface\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eICalculator\u003c/span\u003e\n{\n    \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003eint\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eAdd\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003cspan class=\"hljs-built_in\"\u003eint\u003c/span\u003e x, \u003cspan class=\"hljs-built_in\"\u003eint\u003c/span\u003e y\u003c/span\u003e)\u003c/span\u003e;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\n  And second \u003ccode\u003eIFileService\u003c/code\u003e - it will be used if optional parameter to save result into file will be\n  passed:\n\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"hljs-keyword\"\u003enamespace\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eBusiness.Interfaces\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003einterface\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eIFileService\u003c/span\u003e\n{\n    \u003cspan class=\"hljs-function\"\u003eTask \u003cspan class=\"hljs-title\"\u003eSaveToFileAsync\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e path, \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e content\u003c/span\u003e)\u003c/span\u003e;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen create implementation in \u003ccode\u003eBusiness\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"hljs-keyword\"\u003enamespace\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eBusiness\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eCalculator\u003c/span\u003e : \u003cspan class=\"hljs-title\"\u003eICalculator\u003c/span\u003e\n{\n    \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003eint\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eAdd\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003cspan class=\"hljs-built_in\"\u003eint\u003c/span\u003e x, \u003cspan class=\"hljs-built_in\"\u003eint\u003c/span\u003e y\u003c/span\u003e)\u003c/span\u003e\n    {\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e x + y;\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis is a quite naive implementation, but it's enough for our purpose of building CLI application 😜\u003c/p\u003e\n\u003cp\u003e\n  Implementation of \u003ccode\u003eIFileService\u003c/code\u003e we'll create in \u003ccode\u003eCLI/Services\u003c/code\u003e because it is not strictly related to\n  our business, but to infrastructure:\n\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"hljs-keyword\"\u003enamespace\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eCLI.Services\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eFileService\u003c/span\u003e : \u003cspan class=\"hljs-title\"\u003eIFileService\u003c/span\u003e\n{\n    \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e Task \u003cspan class=\"hljs-title\"\u003eSaveToFileAsync\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e path, \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e content\u003c/span\u003e)\u003c/span\u003e\n    {\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (File.Exists(path))\n        {\n            \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e File.AppendAllTextAsync(path, content, ct);\n        }\n        \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e\n        {\n            \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e File.WriteAllTextAsync(path, content, ct);\n        }\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow as our tests pass, we can move to implementation of our \u003ccode\u003eCLI\u003c/code\u003e.\u003c/p\u003e\n\u003ch2\u003eCLI Project Configuration\u003c/h2\u003e\n\u003cp\u003e\n  At the beginning we have to create \u003ccode\u003eDI\u003c/code\u003e container and register our dependencies.\n  To do it, write following in \u003ccode\u003eCLI/Program.cs\u003c/code\u003e file:\n\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e serviceProvider = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e ServiceCollection()\n    .AddSingleton\u0026#x3C;ICalculator, Calculator\u003e()\n    .AddSingleton\u0026#x3C;IFileService, FileService\u003e()\n    .BuildServiceProvider();\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eConfiguring Logging:\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eCreate file \u003ccode\u003eConfigurationExtensions.cs\u003c/code\u003e file in \u003ccode\u003eCLI\u003c/code\u003e project with content:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"hljs-keyword\"\u003enamespace\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eCLI\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eConfigurationExtensions\u003c/span\u003e\n{\n    \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003estatic\u003c/span\u003e IServiceCollection \u003cspan class=\"hljs-title\"\u003eAddSerilogLogging\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003cspan class=\"hljs-keyword\"\u003ethis\u003c/span\u003e IServiceCollection services\u003c/span\u003e)\u003c/span\u003e\n    {\n        \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e logger = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e LoggerConfiguration()\n            .WriteTo.Console()\n            .CreateLogger();\n\n        services.AddLogging(builder =\u003e\n        {\n            builder.SetMinimumLevel(LogLevel.Trace);\n            builder.AddSerilog(logger, dispose: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e);\n        });\n\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e services;\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\n  This will setup logging with \u003ccode\u003eSerilog\u003c/code\u003e to console and allows to use loggers with dependency injection.\n  Now we can use this extension on our \u003ccode\u003eDI\u003c/code\u003e container in \u003ccode\u003eProgram.cs\u003c/code\u003e:\n\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e serviceProvider = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e ServiceCollection()\n    .AddSerilogLogging()\n    .AddSingleton\u0026#x3C;ICalculator, Calculator\u003e()\n    .AddSingleton\u0026#x3C;IFileService, FileService\u003e()\n    .BuildServiceProvider();\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eMediatR:\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eNow creating \u003ccode\u003eMediatR\u003c/code\u003e command for adding numbers in \u003ccode\u003eBusiness/Requests\u003c/code\u003e folder:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"hljs-keyword\"\u003enamespace\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eBusiness.Requests\u003c/span\u003e;\n\n\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003erecord\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eAddNumbersCommand\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003cspan class=\"hljs-built_in\"\u003eint\u003c/span\u003e X, \u003cspan class=\"hljs-built_in\"\u003eint\u003c/span\u003e Y, \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e? ResultPath\u003c/span\u003e) : IRequest\u0026#x3C;\u003cspan class=\"hljs-built_in\"\u003eint\u003c/span\u003e\u003e\u003c/span\u003e\n{ }\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eCommand contains \u003ccode\u003enullable\u003c/code\u003e ResultPath. If it exists we will save result to file by this provided path.\u003c/p\u003e\n\u003cp\u003eAnd handler for it in \u003ccode\u003eBusiness/Handlers\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"hljs-keyword\"\u003enamespace\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eBusiness.Handlers\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eAddNumbersHandler\u003c/span\u003e : \u003cspan class=\"hljs-title\"\u003eIRequestHandler\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title\"\u003eAddNumbersCommand\u003c/span\u003e\u003e\n{\n    \u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ereadonly\u003c/span\u003e ILogger\u0026#x3C;AddNumbersHandler\u003e _logger;\n    \u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ereadonly\u003c/span\u003e ICalculator _calculator;\n    \u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ereadonly\u003c/span\u003e IFileService _fileService;\n\n    \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eAddNumbersHandler\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\n        ILogger\u0026#x3C;AddNumbersHandler\u003e logger,\n        ICalculator calculator,\n        IFileService fileService\n    \u003c/span\u003e)\u003c/span\u003e\n    {\n        _logger = logger;\n        _calculator = calculator;\n        _fileService = fileService;\n    }\n\n    \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e Task\u0026#x3C;Unit\u003e \u003cspan class=\"hljs-title\"\u003eHandle\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eAddNumbersCommand request, CancellationToken ct\u003c/span\u003e)\u003c/span\u003e\n    {\n        \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e (x, y, resultPath) = request;\n        \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e\n        {\n            _logger.LogInformation(\u003cspan class=\"hljs-string\"\u003e\"Adding values {X} and {Y}\"\u003c/span\u003e, x, y);\n            \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e result = _calculator.Add(x, y);\n            _logger.LogInformation(\u003cspan class=\"hljs-string\"\u003e\"Calculated result: {Result}\"\u003c/span\u003e, result);\n\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (resultPath \u003cspan class=\"hljs-keyword\"\u003eis\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enot\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e)\n            {\n                _logger.LogInformation(\u003cspan class=\"hljs-string\"\u003e\"Saving result to file {Path}\"\u003c/span\u003e, resultPath);\n                \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e content = \u003cspan class=\"hljs-string\"\u003e$\"Adding \u003cspan class=\"hljs-subst\"\u003e{x}\u003c/span\u003e + \u003cspan class=\"hljs-subst\"\u003e{y}\u003c/span\u003e = \u003cspan class=\"hljs-subst\"\u003e{result}\u003c/span\u003e\\n\"\u003c/span\u003e;\n                \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e _fileService.SaveToFileAsync(resultPath, content, ct);\n                _logger.LogInformation(\u003cspan class=\"hljs-string\"\u003e\"Result saved\"\u003c/span\u003e);\n            }\n\n            \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e Unit.Value;\n        }\n        \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (Exception e)\n        {\n            _logger.LogError(e, \u003cspan class=\"hljs-string\"\u003e\"Error happened during handling addition of values {X} and {Y}\"\u003c/span\u003e, x, y);\n            \u003cspan class=\"hljs-keyword\"\u003ethrow\u003c/span\u003e;\n        }\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eTo register \u003ccode\u003eMediatR\u003c/code\u003e with \u003ccode\u003eDI\u003c/code\u003e container add it to \u003ccode\u003eServiceProvider\u003c/code\u003e configuration in \u003ccode\u003eProgram.cs\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e serviceProvider = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e ServiceCollection()\n    .AddSerilogLogging()\n    .AddMediatR(\u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e(AddNumbersHandler).Assembly)\n    .AddSingleton\u0026#x3C;ICalculator, Calculator\u003e()\n    .AddSingleton\u0026#x3C;IFileService, FileService\u003e()\n    .BuildServiceProvider();\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eCLI\u003c/h2\u003e\n\u003cp\u003e\n  Now we can start to create a main part of this guide - CLI parameters parsing and routing them to\n  proper command handler.\n\u003c/p\u003e\n\u003cp\u003eIn \u003ccode\u003eProgram.cs\u003c/code\u003e file add following code, which creates \u003ccode\u003eMicrosoft.Extensions.CommandLineUtils\u003c/code\u003e app:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e app = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e CommandLineApplication();\napp.Name = \u003cspan class=\"hljs-string\"\u003e\"CSharp CLI Application\"\u003c/span\u003e;\napp.Description = \u003cspan class=\"hljs-string\"\u003e\"Simple C# console application\"\u003c/span\u003e;\napp.HelpOption(\u003cspan class=\"hljs-string\"\u003e\"-h|--help\"\u003c/span\u003e);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHere we create command line app object, where define it's name, description and define command to get help.\u003c/p\u003e\n\u003cp\u003eNext we will configure \u003ccode\u003eadd numbers\u003c/code\u003e command.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-csharp\"\u003e\u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e mediator = serviceProvider.GetRequiredService\u0026#x3C;IMediator\u003e();\n\u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e logger = serviceProvider.GetRequiredService\u0026#x3C;ILogger\u0026#x3C;Program\u003e\u003e();\n\napp.Command(\u003cspan class=\"hljs-string\"\u003e\"add\"\u003c/span\u003e, (opt) =\u003e\n{\n    \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e x = opt.Argument(\n        name: \u003cspan class=\"hljs-string\"\u003e\"\u0026#x3C;x\u003e\"\u003c/span\u003e,\n        description: \u003cspan class=\"hljs-string\"\u003e\"first number\"\u003c/span\u003e\n    );\n    \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e y = opt.Argument(\n        name: \u003cspan class=\"hljs-string\"\u003e\"\u0026#x3C;y\u003e\"\u003c/span\u003e,\n        description: \u003cspan class=\"hljs-string\"\u003e\"second number\"\u003c/span\u003e\n    );\n    \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e resultPath = opt.Option(\n        template: \u003cspan class=\"hljs-string\"\u003e\"-rp|--result-path\"\u003c/span\u003e,\n        description: \u003cspan class=\"hljs-string\"\u003e\"file path to save result\"\u003c/span\u003e,\n        CommandOptionType.SingleValue\n    );\n    opt.HelpOption(\u003cspan class=\"hljs-string\"\u003e\"-h|--help\"\u003c/span\u003e);\n\n    opt.OnExecute(\u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e () =\u003e\n    {\n        \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e\n        {\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!\u003cspan class=\"hljs-built_in\"\u003eint\u003c/span\u003e.TryParse(x.Value, \u003cspan class=\"hljs-keyword\"\u003eout\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e xInt))\n            {\n                \u003cspan class=\"hljs-keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e ArgumentException(\u003cspan class=\"hljs-string\"\u003e$\"first argument \u003cspan class=\"hljs-subst\"\u003e{x.Value}\u003c/span\u003e is not a number\"\u003c/span\u003e);\n            }\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!\u003cspan class=\"hljs-built_in\"\u003eint\u003c/span\u003e.TryParse(y.Value, \u003cspan class=\"hljs-keyword\"\u003eout\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e yInt))\n            {\n                \u003cspan class=\"hljs-keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e ArgumentException(\u003cspan class=\"hljs-string\"\u003e$\"first argument \u003cspan class=\"hljs-subst\"\u003e{y.Value}\u003c/span\u003e is not a number\"\u003c/span\u003e);\n            }\n\n            \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e command = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e AddNumbersCommand\n            (\n                X: xInt,\n                Y: yInt,\n                ResultPath: resultPath.Values.Count \u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e ? resultPath.Values[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e] : \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e\n            );\n            \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e mediator.Send(command);\n            \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\n        }\n        \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (ArgumentException e)\n        {\n            logger.LogError(\u003cspan class=\"hljs-string\"\u003e\"Error happened: {Message}\"\u003c/span\u003e, e.Message);\n            \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n        }\n        \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (Exception)\n        {\n            \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n        }\n    });\n});\n\napp.Execute(args);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHere with \u003ccode\u003eapp.Command()\u003c/code\u003e we create command handler with name \u003ccode\u003eadd\u003c/code\u003e. If we run \u003ccode\u003e--help\u003c/code\u003e command of our app(inside of \u003ccode\u003e./CLI\u003c/code\u003e project) we will see something like this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-txt\"\u003e$: dotnet run -- --help\n\n\nUsage: CSharp CLI Application [options] [command]\n\nOptions:\n  -h|--help  Show help information\n\nCommands:\n  add\n\nUse \"CSharp CLI Application [command] --help\" for more information about a command.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen inside of command handler delegate we define arguments - first and second numbers to add and optional parameters - file path to save result and define help option for \u003ccode\u003eadd\u003c/code\u003e command.\u003c/p\u003e\n\u003cp\u003e\n  And finally with \u003ccode\u003eopt.OnExecute\u003c/code\u003e we define handler function, which will be executed to handle \u003ccode\u003eadd\u003c/code\u003e command.\n  Inside of this handler we specify logic to parse arguments to their target types and handling of\n  possible parsing errors. When we have parsed parameters, using \u003ccode\u003emediator\u003c/code\u003e we route our data to\n  proper \u003ccode\u003eadd numbers\u003c/code\u003e handler.\n\u003c/p\u003e\n\u003cp\u003eRunning help for \u003ccode\u003eadd\u003c/code\u003e command in our \u003ccode\u003eCLI\u003c/code\u003e project we will get following result:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-txt\"\u003e$: dotnet run -- add --help\n\n\nUsage: CSharp CLI Application add [arguments] [options]\n\nArguments:\n  \u0026#x3C;x\u003e  first number\n  \u0026#x3C;y\u003e  second number\n\nOptions:\n  -rp|--result-path  file path to save result\n  -h|--help          Show help information\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow we can test our app. Running it with valid data gives following:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-txt\"\u003e$: dotnet run -- add 2 2\n\n[23:10:46 INF] Adding values 2 and 2\n[23:10:46 INF] Calculated result: 4\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eRunning with optional file path for saving result:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-txt\"\u003e$: dotnet run -- add 2 2 --result-path results.txt\n\n[23:11:59 INF] Adding values 2 and 2\n[23:11:59 INF] Calculated result: 4\n[23:11:59 INF] Saving result to file results.txt\n[23:11:59 INF] Result saved\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd also file \u003ccode\u003eresults.txt\u003c/code\u003e will be created with content:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-txt\"\u003eAdding 2 + 2 = 4\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIf we provide not valid input for add:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-txt\"\u003e$: dotnet run -- add 2 asf\n\n[23:13:35 ERR] Error happened: Second argument asf is not a number\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd if we provide command, that does not exist program will return an error:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-txt\"\u003e$: dotnet run -- subtract 2 2\n\nSpecify --help for a list of available options and commands.\nUnhandled exception. Microsoft.Extensions.CommandLineUtils.CommandParsingException: Unrecognized command or argument 'subtract'\n   at Microsoft.Extensions.CommandLineUtils.CommandLineApplication.Execute(String[] args)\n   at Program.\u0026#x3C;Main\u003e$(String[] args) in ./csharp-cli-app/CLI/Program.cs:line 78\n\u003c/code\u003e\u003c/pre\u003e\n"}},"__N_SSG":true},"page":"/notes/[...noteKey]","query":{"noteKey":["csharp","cli-app"]},"buildId":"rEbIxoA2O-xiW5DUZwlG8","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>