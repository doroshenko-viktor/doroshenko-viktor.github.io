<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Mongo Replication In Docker</title><link rel="icon" href="/images/favicon.ico"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/b65b5b41f2379875.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b65b5b41f2379875.css" data-n-g=""/><link rel="preload" href="/_next/static/css/24d1e8cd2dc8a4d8.css" as="style"/><link rel="stylesheet" href="/_next/static/css/24d1e8cd2dc8a4d8.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-fc97f3f1282ce3ed.js" defer=""></script><script src="/_next/static/chunks/main-f4ae3437c92c1efc.js" defer=""></script><script src="/_next/static/chunks/pages/_app-85d7488a393e293e.js" defer=""></script><script src="/_next/static/chunks/211-ca3cd870e26e881a.js" defer=""></script><script src="/_next/static/chunks/pages/notes/%5B...noteKey%5D-8148e70bfe2248a4.js" defer=""></script><script src="/_next/static/yuH0hRNUDvqFhvo-Vzqg3/_buildManifest.js" defer=""></script><script src="/_next/static/yuH0hRNUDvqFhvo-Vzqg3/_ssgManifest.js" defer=""></script><script src="/_next/static/yuH0hRNUDvqFhvo-Vzqg3/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><section class="Layout_centeredSection__nmU9U"><ul class="NavigationBar_navbar__CBMoV"><span><li><a class="NavigationBar_navitem__LKB5F" href="/">Home</a></li><span class="NavigationBar_separator__qvEVD">|</span></span><span><li><button class="NavigationBar_navitem__LKB5F">Back</button></li><span class="NavigationBar_separator__qvEVD">|</span></span></ul><h1 class="NoteFormattedContent_noteTitle__Oi9sD">Mongo Replication In Docker</h1><article class="NoteFormattedContent_note__8cHeE">
<p>
  Mongo replication allows to build more scalable and fault tolerant systems. But using <code>MongoDb</code>
  locally usually we use single instance versions. This is fine for many development usecases. But
  some features, for example Mongo transactions are available only with replication.
</p>
<p>
  We will set up docker compose configuration, which will allow to run several <code>MongoDb</code> containers,
  able to communicate in mutual network. All these containers will be accessible also from local machine.
</p>
<p>To create local instance of <code>MongoDb</code> in cluster but only with single node:</p>
<pre><code class="hljs language-yml"><span class="hljs-attr">version:</span> <span class="hljs-string">"3.8"</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">mongodb:</span>
    <span class="hljs-attr">image :</span> <span class="hljs-string">mongo</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mongodb</span>
    <span class="hljs-attr">hostname:</span> <span class="hljs-string">mongodb</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">on-failure</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PUID=1000</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PGID=1000</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">MONGO_INITDB_ROOT_USERNAME=guest</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">MONGO_INITDB_ROOT_PASSWORD=guest</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">MONGO_INITDB_DATABASE=my-service</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">MONGO_REPLICA_SET_NAME=rs0</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mongodb4_data:/data/db</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./:/opt/keyfile/</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">27017</span><span class="hljs-string">:27017</span>
    <span class="hljs-attr">healthcheck:</span>
      <span class="hljs-attr">test:</span> <span class="hljs-string">test</span> <span class="hljs-string">$$(echo</span> <span class="hljs-string">"rs.initiate().ok || rs.status().ok"</span> <span class="hljs-string">|</span> <span class="hljs-string">mongo</span> <span class="hljs-string">-u</span> <span class="hljs-string">$${MONGO_INITDB_ROOT_USERNAME}</span> <span class="hljs-string">-p</span> <span class="hljs-string">$${MONGO_INITDB_ROOT_PASSWORD}</span> <span class="hljs-string">--quiet)</span> <span class="hljs-string">-eq</span> <span class="hljs-number">1</span>
      <span class="hljs-attr">interval:</span> <span class="hljs-string">10s</span>
      <span class="hljs-attr">start_period:</span> <span class="hljs-string">30s</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">"--bind_ip_all --keyFile /opt/keyfile/keyfile --replSet rs0"</span>
<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">mongodb4_data:</span>
</code></pre>
<h2>Resources</h2>
<ul>
  <li><a href="https://www.sohamkamani.com/docker/mongo-replica-set/">Creating a MongoDB Replica Set Using Docker</a></li>
  <li>
    <a href="https://blog.devgenius.io/how-to-deploy-a-mongodb-replicaset-using-docker-compose-a538100db471"></a><a href="https://stackoverflow.com/questions/61486024/mongo-container-with-a-replica-set-with-only-one-node-in-docker-compose">https://stackoverflow.com/questions/61486024/mongo-container-with-a-replica-set-with-only-one-node-in-docker-compose</a>
    <a href="https://blog.tericcabrel.com/mongodb-replica-set-docker-compose/">https://blog.tericcabrel.com/mongodb-replica-set-docker-compose/</a>
  </li>
</ul>
</article></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"noteKey":["infrastructure","docker","mongo-replication-docker"],"note":{"title":"Mongo Replication In Docker","date":"2022-05-31","content":"\n\u003cp\u003e\n  Mongo replication allows to build more scalable and fault tolerant systems. But using \u003ccode\u003eMongoDb\u003c/code\u003e\n  locally usually we use single instance versions. This is fine for many development usecases. But\n  some features, for example Mongo transactions are available only with replication.\n\u003c/p\u003e\n\u003cp\u003e\n  We will set up docker compose configuration, which will allow to run several \u003ccode\u003eMongoDb\u003c/code\u003e containers,\n  able to communicate in mutual network. All these containers will be accessible also from local machine.\n\u003c/p\u003e\n\u003cp\u003eTo create local instance of \u003ccode\u003eMongoDb\u003c/code\u003e in cluster but only with single node:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yml\"\u003e\u003cspan class=\"hljs-attr\"\u003eversion:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"3.8\"\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003eservices:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003emongodb:\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eimage :\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003emongo\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003econtainer_name:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003emongodb\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003ehostname:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003emongodb\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003erestart:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eon-failure\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eenvironment:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ePUID=1000\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ePGID=1000\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eMONGO_INITDB_ROOT_USERNAME=guest\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eMONGO_INITDB_ROOT_PASSWORD=guest\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eMONGO_INITDB_DATABASE=my-service\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eMONGO_REPLICA_SET_NAME=rs0\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003evolumes:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003emongodb4_data:/data/db\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e./:/opt/keyfile/\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003eports:\u003c/span\u003e\n      \u003cspan class=\"hljs-bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e27017\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e:27017\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003ehealthcheck:\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003etest:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003etest\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$$(echo\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"rs.initiate().ok || rs.status().ok\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e|\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003emongo\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-u\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$${MONGO_INITDB_ROOT_USERNAME}\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-p\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e$${MONGO_INITDB_ROOT_PASSWORD}\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e--quiet)\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e-eq\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003einterval:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e10s\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003estart_period:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e30s\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003ecommand:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"--bind_ip_all --keyFile /opt/keyfile/keyfile --replSet rs0\"\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003evolumes:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003emongodb4_data:\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eResources\u003c/h2\u003e\n\u003cul\u003e\n  \u003cli\u003e\u003ca href=\"https://www.sohamkamani.com/docker/mongo-replica-set/\"\u003eCreating a MongoDB Replica Set Using Docker\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\n    \u003ca href=\"https://blog.devgenius.io/how-to-deploy-a-mongodb-replicaset-using-docker-compose-a538100db471\"\u003e\u003c/a\u003e\u003ca href=\"https://stackoverflow.com/questions/61486024/mongo-container-with-a-replica-set-with-only-one-node-in-docker-compose\"\u003ehttps://stackoverflow.com/questions/61486024/mongo-container-with-a-replica-set-with-only-one-node-in-docker-compose\u003c/a\u003e\n    \u003ca href=\"https://blog.tericcabrel.com/mongodb-replica-set-docker-compose/\"\u003ehttps://blog.tericcabrel.com/mongodb-replica-set-docker-compose/\u003c/a\u003e\n  \u003c/li\u003e\n\u003c/ul\u003e\n"}},"__N_SSG":true},"page":"/notes/[...noteKey]","query":{"noteKey":["infrastructure","docker","mongo-replication-docker"]},"buildId":"yuH0hRNUDvqFhvo-Vzqg3","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>