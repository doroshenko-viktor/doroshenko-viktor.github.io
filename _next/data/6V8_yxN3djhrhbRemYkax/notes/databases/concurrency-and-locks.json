{"pageProps":{"noteKey":["databases","concurrency-and-locks"],"note":{"title":"SQL Databases Concurrency And Locks","date":"2025-10-17","content":"\n<h2>Introduction</h2>\n<p>Transactions are fundamental building blocks of database systems that ensure data integrity and consistency. In PostgreSQL, understanding how transactions work and how different isolation levels affect concurrent operations is crucial for building reliable applications.</p>\n<p>This guide explores PostgreSQL's transaction model, isolation levels, concurrency control mechanisms, and best practices for handling transactions in production environments.</p>\n<h2>What is a Transaction?</h2>\n<p>A transaction is a sequence of one or more SQL operations that are treated as a single unit of work. Transactions follow the ACID properties:</p>\n<ul>\n  <li><strong>Atomicity</strong>: All operations in a transaction succeed or all fail together</li>\n  <li><strong>Consistency</strong>: Transactions move the database from one valid state to another</li>\n  <li><strong>Isolation</strong>: Concurrent transactions don't interfere with each other</li>\n  <li><strong>Durability</strong>: Once committed, changes persist even after system failures</li>\n</ul>\n<h2>Basic Transaction Commands</h2>\n<h3>Starting and Ending Transactions</h3>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Begin a transaction</span>\n<span class=\"hljs-keyword\">BEGIN</span>;\n\n<span class=\"hljs-comment\">-- Perform operations</span>\n<span class=\"hljs-keyword\">UPDATE</span> accounts <span class=\"hljs-keyword\">SET</span> balance <span class=\"hljs-operator\">=</span> balance <span class=\"hljs-operator\">-</span> <span class=\"hljs-number\">100</span> <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">1</span>;\n<span class=\"hljs-keyword\">UPDATE</span> accounts <span class=\"hljs-keyword\">SET</span> balance <span class=\"hljs-operator\">=</span> balance <span class=\"hljs-operator\">+</span> <span class=\"hljs-number\">100</span> <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">2</span>;\n\n<span class=\"hljs-comment\">-- Commit the transaction</span>\n<span class=\"hljs-keyword\">COMMIT</span>;\n</code></pre>\n<h3>Rolling Back Transactions</h3>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-keyword\">BEGIN</span>;\n\n<span class=\"hljs-keyword\">UPDATE</span> accounts <span class=\"hljs-keyword\">SET</span> balance <span class=\"hljs-operator\">=</span> balance <span class=\"hljs-operator\">-</span> <span class=\"hljs-number\">100</span> <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">1</span>;\n\n<span class=\"hljs-comment\">-- Something went wrong, undo everything</span>\n<span class=\"hljs-keyword\">ROLLBACK</span>;\n</code></pre>\n<h3>Savepoints</h3>\n<p>Savepoints allow you to partially rollback a transaction:</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-keyword\">BEGIN</span>;\n\n<span class=\"hljs-keyword\">UPDATE</span> accounts <span class=\"hljs-keyword\">SET</span> balance <span class=\"hljs-operator\">=</span> balance <span class=\"hljs-operator\">-</span> <span class=\"hljs-number\">100</span> <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">1</span>;\n\n<span class=\"hljs-keyword\">SAVEPOINT</span> my_savepoint;\n\n<span class=\"hljs-keyword\">UPDATE</span> accounts <span class=\"hljs-keyword\">SET</span> balance <span class=\"hljs-operator\">=</span> balance <span class=\"hljs-operator\">+</span> <span class=\"hljs-number\">100</span> <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">2</span>;\n\n<span class=\"hljs-comment\">-- Rollback only to the savepoint</span>\n<span class=\"hljs-keyword\">ROLLBACK</span> <span class=\"hljs-keyword\">TO</span> <span class=\"hljs-keyword\">SAVEPOINT</span> my_savepoint;\n\n<span class=\"hljs-comment\">-- The first UPDATE is still active</span>\n<span class=\"hljs-keyword\">COMMIT</span>;\n</code></pre>\n<h2>Isolation Levels</h2>\n<p>PostgreSQL implements four standard SQL isolation levels, each providing different guarantees about what phenomena can occur when transactions run concurrently.</p>\n<h3>Read Phenomena</h3>\n<p>Before discussing isolation levels, it's important to understand the read phenomena they prevent:</p>\n<p><strong>Dirty Read</strong>: Reading uncommitted changes from another transaction</p>\n<p><strong>Non-Repeatable Read</strong>: Reading the same row twice in a transaction and getting different values because another transaction modified and committed the row</p>\n<p><strong>Phantom Read</strong>: Re-executing a query and finding rows that weren't there before because another transaction inserted and committed new rows</p>\n<p><strong>Serialization Anomaly</strong>: The result of successfully committing a group of transactions is inconsistent with all possible orderings of running those transactions one at a time</p>\n<h3>PostgreSQL Isolation Levels</h3>\n<table>\n  <thead>\n    <tr>\n      <th>Isolation Level</th>\n      <th>Dirty Read</th>\n      <th>Non-Repeatable Read</th>\n      <th>Phantom Read</th>\n      <th>Serialization Anomaly</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>Read Uncommitted</td>\n      <td>Not possible*</td>\n      <td>Possible</td>\n      <td>Possible</td>\n      <td>Possible</td>\n    </tr>\n    <tr>\n      <td>Read Committed</td>\n      <td>Not possible</td>\n      <td>Possible</td>\n      <td>Possible</td>\n      <td>Possible</td>\n    </tr>\n    <tr>\n      <td>Repeatable Read</td>\n      <td>Not possible</td>\n      <td>Not possible</td>\n      <td>Not possible**</td>\n      <td>Possible</td>\n    </tr>\n    <tr>\n      <td>Serializable</td>\n      <td>Not possible</td>\n      <td>Not possible</td>\n      <td>Not possible</td>\n      <td>Not possible</td>\n    </tr>\n  </tbody>\n</table>\n<p>*PostgreSQL treats Read Uncommitted as Read Committed<br>**PostgreSQL prevents phantom reads at Repeatable Read level</p>\n<h3>Read Committed (Default)</h3>\n<p>This is PostgreSQL's default isolation level. Each query within a transaction sees a snapshot of the database as of the start of that query.</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Session 1</span>\n<span class=\"hljs-keyword\">BEGIN</span>;\n<span class=\"hljs-keyword\">SELECT</span> balance <span class=\"hljs-keyword\">FROM</span> accounts <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">1</span>;\n<span class=\"hljs-comment\">-- Returns 1000</span>\n</code></pre>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Session 2</span>\n<span class=\"hljs-keyword\">BEGIN</span>;\n<span class=\"hljs-keyword\">UPDATE</span> accounts <span class=\"hljs-keyword\">SET</span> balance <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">1500</span> <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">1</span>;\n<span class=\"hljs-keyword\">COMMIT</span>;\n</code></pre>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Session 1 (continuing)</span>\n<span class=\"hljs-keyword\">SELECT</span> balance <span class=\"hljs-keyword\">FROM</span> accounts <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">1</span>;\n<span class=\"hljs-comment\">-- Returns 1500 (sees the committed change)</span>\n<span class=\"hljs-keyword\">COMMIT</span>;\n</code></pre>\n<p><strong>Use cases</strong>: Most applications work well with Read Committed. It provides good performance while preventing dirty reads.</p>\n<h3>Repeatable Read</h3>\n<p>Each query in a transaction sees a snapshot of the database as of the start of the first query in that transaction.</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Session 1</span>\n<span class=\"hljs-keyword\">BEGIN</span> TRANSACTION ISOLATION LEVEL REPEATABLE READ;\n<span class=\"hljs-keyword\">SELECT</span> balance <span class=\"hljs-keyword\">FROM</span> accounts <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">1</span>;\n<span class=\"hljs-comment\">-- Returns 1000</span>\n</code></pre>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Session 2</span>\n<span class=\"hljs-keyword\">BEGIN</span>;\n<span class=\"hljs-keyword\">UPDATE</span> accounts <span class=\"hljs-keyword\">SET</span> balance <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">1500</span> <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">1</span>;\n<span class=\"hljs-keyword\">COMMIT</span>;\n</code></pre>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Session 1 (continuing)</span>\n<span class=\"hljs-keyword\">SELECT</span> balance <span class=\"hljs-keyword\">FROM</span> accounts <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">1</span>;\n<span class=\"hljs-comment\">-- Still returns 1000 (doesn't see the committed change)</span>\n<span class=\"hljs-keyword\">COMMIT</span>;\n</code></pre>\n<p><strong>Use cases</strong>: Long-running reports, data exports, or any operation that needs a consistent view of data throughout the transaction.</p>\n<h3>Serializable</h3>\n<p>The strictest isolation level. Transactions execute as if they ran one at a time, with no concurrency. PostgreSQL uses Serializable Snapshot Isolation (SSI) to implement this efficiently.</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Session 1</span>\n<span class=\"hljs-keyword\">BEGIN</span> TRANSACTION ISOLATION LEVEL SERIALIZABLE;\n<span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-built_in\">SUM</span>(balance) <span class=\"hljs-keyword\">FROM</span> accounts <span class=\"hljs-keyword\">WHERE</span> type <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">'checking'</span>;\n<span class=\"hljs-comment\">-- Returns 10000</span>\n</code></pre>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Session 2</span>\n<span class=\"hljs-keyword\">BEGIN</span> TRANSACTION ISOLATION LEVEL SERIALIZABLE;\n<span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-keyword\">INTO</span> accounts (type, balance) <span class=\"hljs-keyword\">VALUES</span> (<span class=\"hljs-string\">'checking'</span>, <span class=\"hljs-number\">500</span>);\n<span class=\"hljs-keyword\">COMMIT</span>;\n</code></pre>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Session 1 (continuing)</span>\n<span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-keyword\">INTO</span> audit_log (total_checking)\n<span class=\"hljs-keyword\">VALUES</span> ((<span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-built_in\">SUM</span>(balance) <span class=\"hljs-keyword\">FROM</span> accounts <span class=\"hljs-keyword\">WHERE</span> type <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">'checking'</span>));\n<span class=\"hljs-comment\">-- ERROR: could not serialize access due to read/write dependencies</span>\n</code></pre>\n<p><strong>Use cases</strong>: Financial systems, inventory management, or any scenario where serialization anomalies would cause data corruption.</p>\n<h3>Setting Isolation Levels</h3>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- For a single transaction</span>\n<span class=\"hljs-keyword\">BEGIN</span> TRANSACTION ISOLATION LEVEL REPEATABLE READ;\n\n<span class=\"hljs-comment\">-- For the current session</span>\n<span class=\"hljs-keyword\">SET</span> SESSION CHARACTERISTICS <span class=\"hljs-keyword\">AS</span> TRANSACTION ISOLATION LEVEL REPEATABLE READ;\n\n<span class=\"hljs-comment\">-- Using SET TRANSACTION</span>\n<span class=\"hljs-keyword\">BEGIN</span>;\n<span class=\"hljs-keyword\">SET</span> TRANSACTION ISOLATION LEVEL SERIALIZABLE;\n</code></pre>\n<h2>Multi-Version Concurrency Control (MVCC)</h2>\n<p>PostgreSQL uses MVCC to implement isolation levels efficiently. Instead of locking rows, it maintains multiple versions of data:</p>\n<ul>\n  <li>When a row is updated, PostgreSQL creates a new version rather than overwriting the old one</li>\n  <li>Each transaction sees the appropriate version based on its isolation level and start time</li>\n  <li>Old versions are cleaned up by the VACUUM process</li>\n</ul>\n<h3>Benefits of MVCC</h3>\n<ul>\n  <li>Readers don't block writers</li>\n  <li>Writers don't block readers</li>\n  <li>High concurrency with minimal locking</li>\n  <li>No dirty reads</li>\n</ul>\n<h3>Transaction IDs</h3>\n<p>Every transaction receives a unique transaction ID (XID). Each row version is tagged with XIDs indicating when it was created and deleted:</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- View transaction IDs (requires superuser or appropriate permissions)</span>\n<span class=\"hljs-keyword\">SELECT</span> txid_current();\n\n<span class=\"hljs-comment\">-- See row versions (for debugging)</span>\n<span class=\"hljs-keyword\">SELECT</span> xmin, xmax, <span class=\"hljs-operator\">*</span> <span class=\"hljs-keyword\">FROM</span> accounts;\n</code></pre>\n<h2>Locking in PostgreSQL</h2>\n<p>While MVCC reduces the need for locks, PostgreSQL still uses locks for certain operations.</p>\n<h3>Lock Modes</h3>\n<p><strong>Table-Level Locks</strong>:</p>\n<ul>\n  <li>ACCESS SHARE: Acquired by SELECT</li>\n  <li>ROW SHARE: Acquired by SELECT FOR UPDATE</li>\n  <li>ROW EXCLUSIVE: Acquired by UPDATE, DELETE, INSERT</li>\n  <li>SHARE UPDATE EXCLUSIVE: Acquired by VACUUM, CREATE INDEX CONCURRENTLY</li>\n  <li>SHARE: Acquired by CREATE INDEX</li>\n  <li>SHARE ROW EXCLUSIVE: Acquired by CREATE TRIGGER</li>\n  <li>EXCLUSIVE: Blocks all concurrent access except ACCESS SHARE</li>\n  <li>ACCESS EXCLUSIVE: Acquired by DROP TABLE, TRUNCATE, REINDEX, VACUUM FULL</li>\n</ul>\n<p><strong>Row-Level Locks</strong>:</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Lock rows for update (blocks other locks)</span>\n<span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-operator\">*</span> <span class=\"hljs-keyword\">FROM</span> accounts <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">UPDATE</span>;\n\n<span class=\"hljs-comment\">-- Lock rows but allow other shared locks</span>\n<span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-operator\">*</span> <span class=\"hljs-keyword\">FROM</span> accounts <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">FOR</span> SHARE;\n\n<span class=\"hljs-comment\">-- Skip locked rows instead of waiting</span>\n<span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-operator\">*</span> <span class=\"hljs-keyword\">FROM</span> queue <span class=\"hljs-keyword\">WHERE</span> status <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">'pending'</span>\n<span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">UPDATE</span> <span class=\"hljs-keyword\">SKIP</span> LOCKED LIMIT <span class=\"hljs-number\">1</span>;\n\n<span class=\"hljs-comment\">-- Don't wait for locks, error immediately</span>\n<span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-operator\">*</span> <span class=\"hljs-keyword\">FROM</span> accounts <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">UPDATE</span> NOWAIT;\n</code></pre>\n<h3>Advisory Locks</h3>\n<p>PostgreSQL provides advisory locks for application-level coordination:</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Session-level advisory lock</span>\n<span class=\"hljs-keyword\">SELECT</span> pg_advisory_lock(<span class=\"hljs-number\">12345</span>);\n<span class=\"hljs-keyword\">SELECT</span> pg_advisory_unlock(<span class=\"hljs-number\">12345</span>);\n\n<span class=\"hljs-comment\">-- Transaction-level advisory lock</span>\n<span class=\"hljs-keyword\">SELECT</span> pg_advisory_xact_lock(<span class=\"hljs-number\">12345</span>);\n<span class=\"hljs-comment\">-- Automatically released at transaction end</span>\n\n<span class=\"hljs-comment\">-- Try lock without blocking</span>\n<span class=\"hljs-keyword\">SELECT</span> pg_try_advisory_lock(<span class=\"hljs-number\">12345</span>);\n</code></pre>\n<h2>Handling Deadlocks</h2>\n<p>A deadlock occurs when transactions wait for each other in a cycle. PostgreSQL automatically detects and resolves deadlocks by aborting one transaction.</p>\n<h3>Example Deadlock</h3>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Session 1</span>\n<span class=\"hljs-keyword\">BEGIN</span>;\n<span class=\"hljs-keyword\">UPDATE</span> accounts <span class=\"hljs-keyword\">SET</span> balance <span class=\"hljs-operator\">=</span> balance <span class=\"hljs-operator\">-</span> <span class=\"hljs-number\">100</span> <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">1</span>;\n<span class=\"hljs-comment\">-- Waiting to update id = 2</span>\n</code></pre>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Session 2</span>\n<span class=\"hljs-keyword\">BEGIN</span>;\n<span class=\"hljs-keyword\">UPDATE</span> accounts <span class=\"hljs-keyword\">SET</span> balance <span class=\"hljs-operator\">=</span> balance <span class=\"hljs-operator\">-</span> <span class=\"hljs-number\">100</span> <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">2</span>;\n<span class=\"hljs-comment\">-- Waiting to update id = 1</span>\n<span class=\"hljs-keyword\">UPDATE</span> accounts <span class=\"hljs-keyword\">SET</span> balance <span class=\"hljs-operator\">=</span> balance <span class=\"hljs-operator\">+</span> <span class=\"hljs-number\">100</span> <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">1</span>;\n<span class=\"hljs-comment\">-- ERROR: deadlock detected</span>\n</code></pre>\n<h3>Preventing Deadlocks</h3>\n<p>Always access resources in the same order across all transactions:</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Good: consistent ordering</span>\n<span class=\"hljs-keyword\">BEGIN</span>;\n<span class=\"hljs-keyword\">UPDATE</span> accounts <span class=\"hljs-keyword\">SET</span> balance <span class=\"hljs-operator\">=</span> balance <span class=\"hljs-operator\">-</span> <span class=\"hljs-number\">100</span> <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> LEAST(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">2</span>);\n<span class=\"hljs-keyword\">UPDATE</span> accounts <span class=\"hljs-keyword\">SET</span> balance <span class=\"hljs-operator\">=</span> balance <span class=\"hljs-operator\">+</span> <span class=\"hljs-number\">100</span> <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> GREATEST(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">2</span>);\n<span class=\"hljs-keyword\">COMMIT</span>;\n</code></pre>\n<p>Use timeouts:</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Set statement timeout</span>\n<span class=\"hljs-keyword\">SET</span> statement_timeout <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">'5s'</span>;\n\n<span class=\"hljs-comment\">-- Set lock timeout</span>\n<span class=\"hljs-keyword\">SET</span> lock_timeout <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">'2s'</span>;\n</code></pre>\n<h2>Serialization Failures</h2>\n<p>At Repeatable Read and Serializable levels, transactions may fail with serialization errors:</p>\n<pre><code class=\"hljs language-vbnet\"><span class=\"hljs-symbol\">ERROR:</span> could <span class=\"hljs-built_in\">not</span> serialize access due <span class=\"hljs-keyword\">to</span> concurrent update\n<span class=\"hljs-symbol\">ERROR:</span> could <span class=\"hljs-built_in\">not</span> serialize access due <span class=\"hljs-keyword\">to</span> read/write dependencies among transactions\n</code></pre>\n<h3>Handling Serialization Errors</h3>\n<p>Always implement retry logic:</p>\n<pre><code class=\"hljs language-python\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">transfer_money</span>(<span class=\"hljs-params\">from_id, to_id, amount</span>):\n    max_retries = <span class=\"hljs-number\">3</span>\n    <span class=\"hljs-keyword\">for</span> attempt <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(max_retries):\n        <span class=\"hljs-keyword\">try</span>:\n            <span class=\"hljs-keyword\">with</span> connection.cursor() <span class=\"hljs-keyword\">as</span> cur:\n                cur.execute(<span class=\"hljs-string\">\"BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE\"</span>)\n                cur.execute(\n                    <span class=\"hljs-string\">\"UPDATE accounts SET balance = balance - %s WHERE id = %s\"</span>,\n                    (amount, from_id)\n                )\n                cur.execute(\n                    <span class=\"hljs-string\">\"UPDATE accounts SET balance = balance + %s WHERE id = %s\"</span>,\n                    (amount, to_id)\n                )\n                cur.execute(<span class=\"hljs-string\">\"COMMIT\"</span>)\n                <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">True</span>\n        <span class=\"hljs-keyword\">except</span> SerializationFailure:\n            <span class=\"hljs-keyword\">if</span> attempt &#x3C; max_retries - <span class=\"hljs-number\">1</span>:\n                time.sleep(<span class=\"hljs-number\">0.1</span> * (<span class=\"hljs-number\">2</span> ** attempt))  <span class=\"hljs-comment\"># Exponential backoff</span>\n                <span class=\"hljs-keyword\">continue</span>\n            <span class=\"hljs-keyword\">raise</span>\n</code></pre>\n<h2>Transaction Best Practices</h2>\n<h3>Keep Transactions Short</h3>\n<p>Long-running transactions hold locks, prevent VACUUM from cleaning old row versions, and increase the chance of conflicts:</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Bad: transaction open while waiting for user input</span>\n<span class=\"hljs-keyword\">BEGIN</span>;\n<span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-operator\">*</span> <span class=\"hljs-keyword\">FROM</span> products <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">123</span>;\n<span class=\"hljs-comment\">-- Application waits for user to confirm</span>\n<span class=\"hljs-keyword\">UPDATE</span> products <span class=\"hljs-keyword\">SET</span> quantity <span class=\"hljs-operator\">=</span> quantity <span class=\"hljs-operator\">-</span> <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">123</span>;\n<span class=\"hljs-keyword\">COMMIT</span>;\n\n<span class=\"hljs-comment\">-- Good: transaction only during database operations</span>\n<span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-operator\">*</span> <span class=\"hljs-keyword\">FROM</span> products <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">123</span>;\n<span class=\"hljs-comment\">-- Application waits for user to confirm</span>\n<span class=\"hljs-keyword\">BEGIN</span>;\n<span class=\"hljs-keyword\">UPDATE</span> products <span class=\"hljs-keyword\">SET</span> quantity <span class=\"hljs-operator\">=</span> quantity <span class=\"hljs-operator\">-</span> <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">123</span>;\n<span class=\"hljs-keyword\">COMMIT</span>;\n</code></pre>\n<h3>Use Appropriate Isolation Levels</h3>\n<p>Don't use stricter isolation than necessary:</p>\n<ul>\n  <li>Use Read Committed for most operations</li>\n  <li>Use Repeatable Read for reports and data exports</li>\n  <li>Use Serializable only when business logic requires it</li>\n</ul>\n<h3>Handle Errors Properly</h3>\n<p>Always handle transaction errors:</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-keyword\">BEGIN</span>;\n<span class=\"hljs-keyword\">SAVEPOINT</span> before_risky_operation;\n\n<span class=\"hljs-comment\">-- Risky operation</span>\n<span class=\"hljs-keyword\">UPDATE</span> accounts <span class=\"hljs-keyword\">SET</span> balance <span class=\"hljs-operator\">=</span> balance <span class=\"hljs-operator\">-</span> <span class=\"hljs-number\">1000</span> <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">1</span>;\n\n<span class=\"hljs-comment\">-- Check constraint violation</span>\nDO $$\n<span class=\"hljs-keyword\">BEGIN</span>\n    IF (<span class=\"hljs-keyword\">SELECT</span> balance <span class=\"hljs-keyword\">FROM</span> accounts <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">1</span>) <span class=\"hljs-operator\">&#x3C;</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span>\n        <span class=\"hljs-keyword\">ROLLBACK</span> <span class=\"hljs-keyword\">TO</span> <span class=\"hljs-keyword\">SAVEPOINT</span> before_risky_operation;\n        RAISE EXCEPTION <span class=\"hljs-string\">'Insufficient funds'</span>;\n    <span class=\"hljs-keyword\">END</span> IF;\n<span class=\"hljs-keyword\">END</span> $$;\n\n<span class=\"hljs-keyword\">COMMIT</span>;\n</code></pre>\n<h3>Use Connection Pooling Wisely</h3>\n<p>Connection pools can complicate transaction management:</p>\n<pre><code class=\"hljs language-python\"><span class=\"hljs-comment\"># Ensure transactions are completed before returning to pool</span>\n<span class=\"hljs-keyword\">try</span>:\n    connection = pool.get_connection()\n    <span class=\"hljs-comment\"># Do work</span>\n    connection.commit()\n<span class=\"hljs-keyword\">except</span> Exception:\n    connection.rollback()\n    <span class=\"hljs-keyword\">raise</span>\n<span class=\"hljs-keyword\">finally</span>:\n    pool.return_connection(connection)\n</code></pre>\n<h3>Monitor Transaction Age</h3>\n<p>Long-running transactions cause problems. Monitor them:</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-keyword\">SELECT</span>\n    pid,\n    now() <span class=\"hljs-operator\">-</span> xact_start <span class=\"hljs-keyword\">AS</span> duration,\n    state,\n    query\n<span class=\"hljs-keyword\">FROM</span> pg_stat_activity\n<span class=\"hljs-keyword\">WHERE</span> xact_start <span class=\"hljs-keyword\">IS</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">NULL</span>\n<span class=\"hljs-keyword\">ORDER</span> <span class=\"hljs-keyword\">BY</span> xact_start;\n</code></pre>\n<h3>Avoid Explicit Locking When Possible</h3>\n<p>Let MVCC do its job. Only use explicit locks when necessary:</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Usually unnecessary</span>\n<span class=\"hljs-keyword\">BEGIN</span>;\nLOCK <span class=\"hljs-keyword\">TABLE</span> accounts <span class=\"hljs-keyword\">IN</span> EXCLUSIVE MODE;\n<span class=\"hljs-comment\">-- operations</span>\n<span class=\"hljs-keyword\">COMMIT</span>;\n\n<span class=\"hljs-comment\">-- Better: let MVCC handle it</span>\n<span class=\"hljs-keyword\">BEGIN</span>;\n<span class=\"hljs-comment\">-- operations</span>\n<span class=\"hljs-keyword\">COMMIT</span>;\n</code></pre>\n<h2>Common Patterns</h2>\n<h3>Optimistic Locking with Version Columns</h3>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> documents (\n    id SERIAL <span class=\"hljs-keyword\">PRIMARY</span> KEY,\n    content TEXT,\n    version <span class=\"hljs-type\">INTEGER</span> <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-number\">1</span>\n);\n\n<span class=\"hljs-comment\">-- Update with version check</span>\n<span class=\"hljs-keyword\">UPDATE</span> documents\n<span class=\"hljs-keyword\">SET</span> content <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">'new content'</span>, version <span class=\"hljs-operator\">=</span> version <span class=\"hljs-operator\">+</span> <span class=\"hljs-number\">1</span>\n<span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">123</span> <span class=\"hljs-keyword\">AND</span> version <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">5</span>;\n\n<span class=\"hljs-comment\">-- Check if update succeeded</span>\n<span class=\"hljs-keyword\">GET</span> DIAGNOSTICS rows_updated <span class=\"hljs-operator\">=</span> ROW_COUNT;\nIF rows_updated <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span>\n    RAISE EXCEPTION <span class=\"hljs-string\">'Document was modified by another user'</span>;\n<span class=\"hljs-keyword\">END</span> IF;\n</code></pre>\n<h3>Queue Processing with SKIP LOCKED</h3>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Multiple workers can process queue concurrently</span>\n<span class=\"hljs-keyword\">BEGIN</span>;\n\n<span class=\"hljs-keyword\">SELECT</span> id <span class=\"hljs-keyword\">FROM</span> job_queue\n<span class=\"hljs-keyword\">WHERE</span> status <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">'pending'</span>\n<span class=\"hljs-keyword\">ORDER</span> <span class=\"hljs-keyword\">BY</span> created_at\n<span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">UPDATE</span> <span class=\"hljs-keyword\">SKIP</span> LOCKED\nLIMIT <span class=\"hljs-number\">1</span>;\n\n<span class=\"hljs-keyword\">UPDATE</span> job_queue\n<span class=\"hljs-keyword\">SET</span> status <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">'processing'</span>, started_at <span class=\"hljs-operator\">=</span> now()\n<span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-operator\">&#x3C;</span>selected_id<span class=\"hljs-operator\">></span>;\n\n<span class=\"hljs-keyword\">COMMIT</span>;\n\n<span class=\"hljs-comment\">-- Process the job</span>\n\n<span class=\"hljs-keyword\">BEGIN</span>;\n<span class=\"hljs-keyword\">UPDATE</span> job_queue\n<span class=\"hljs-keyword\">SET</span> status <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">'completed'</span>, completed_at <span class=\"hljs-operator\">=</span> now()\n<span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-operator\">&#x3C;</span>selected_id<span class=\"hljs-operator\">></span>;\n<span class=\"hljs-keyword\">COMMIT</span>;\n</code></pre>\n<h3>Conditional Inserts</h3>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Insert only if not exists</span>\n<span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-keyword\">INTO</span> users (email, name)\n<span class=\"hljs-keyword\">VALUES</span> (<span class=\"hljs-string\">'user@example.com'</span>, <span class=\"hljs-string\">'John Doe'</span>)\n<span class=\"hljs-keyword\">ON</span> CONFLICT (email) DO NOTHING;\n\n<span class=\"hljs-comment\">-- Insert or update</span>\n<span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-keyword\">INTO</span> user_stats (user_id, login_count)\n<span class=\"hljs-keyword\">VALUES</span> (<span class=\"hljs-number\">123</span>, <span class=\"hljs-number\">1</span>)\n<span class=\"hljs-keyword\">ON</span> CONFLICT (user_id)\nDO <span class=\"hljs-keyword\">UPDATE</span> <span class=\"hljs-keyword\">SET</span> login_count <span class=\"hljs-operator\">=</span> user_stats.login_count <span class=\"hljs-operator\">+</span> <span class=\"hljs-number\">1</span>;\n</code></pre>\n<h2>Monitoring and Troubleshooting</h2>\n<h3>Check Current Transactions</h3>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-keyword\">SELECT</span>\n    pid,\n    usename,\n    application_name,\n    state,\n    query_start,\n    state_change,\n    query\n<span class=\"hljs-keyword\">FROM</span> pg_stat_activity\n<span class=\"hljs-keyword\">WHERE</span> state <span class=\"hljs-operator\">!=</span> <span class=\"hljs-string\">'idle'</span>;\n</code></pre>\n<h3>Find Blocking Queries</h3>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-keyword\">SELECT</span>\n    blocked_locks.pid <span class=\"hljs-keyword\">AS</span> blocked_pid,\n    blocked_activity.usename <span class=\"hljs-keyword\">AS</span> blocked_user,\n    blocking_locks.pid <span class=\"hljs-keyword\">AS</span> blocking_pid,\n    blocking_activity.usename <span class=\"hljs-keyword\">AS</span> blocking_user,\n    blocked_activity.query <span class=\"hljs-keyword\">AS</span> blocked_statement,\n    blocking_activity.query <span class=\"hljs-keyword\">AS</span> blocking_statement\n<span class=\"hljs-keyword\">FROM</span> pg_catalog.pg_locks blocked_locks\n<span class=\"hljs-keyword\">JOIN</span> pg_catalog.pg_stat_activity blocked_activity <span class=\"hljs-keyword\">ON</span> blocked_activity.pid <span class=\"hljs-operator\">=</span> blocked_locks.pid\n<span class=\"hljs-keyword\">JOIN</span> pg_catalog.pg_locks blocking_locks\n    <span class=\"hljs-keyword\">ON</span> blocking_locks.locktype <span class=\"hljs-operator\">=</span> blocked_locks.locktype\n    <span class=\"hljs-keyword\">AND</span> blocking_locks.database <span class=\"hljs-keyword\">IS</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">DISTINCT</span> <span class=\"hljs-keyword\">FROM</span> blocked_locks.database\n    <span class=\"hljs-keyword\">AND</span> blocking_locks.relation <span class=\"hljs-keyword\">IS</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">DISTINCT</span> <span class=\"hljs-keyword\">FROM</span> blocked_locks.relation\n    <span class=\"hljs-keyword\">AND</span> blocking_locks.page <span class=\"hljs-keyword\">IS</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">DISTINCT</span> <span class=\"hljs-keyword\">FROM</span> blocked_locks.page\n    <span class=\"hljs-keyword\">AND</span> blocking_locks.tuple <span class=\"hljs-keyword\">IS</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">DISTINCT</span> <span class=\"hljs-keyword\">FROM</span> blocked_locks.tuple\n    <span class=\"hljs-keyword\">AND</span> blocking_locks.virtualxid <span class=\"hljs-keyword\">IS</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">DISTINCT</span> <span class=\"hljs-keyword\">FROM</span> blocked_locks.virtualxid\n    <span class=\"hljs-keyword\">AND</span> blocking_locks.transactionid <span class=\"hljs-keyword\">IS</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">DISTINCT</span> <span class=\"hljs-keyword\">FROM</span> blocked_locks.transactionid\n    <span class=\"hljs-keyword\">AND</span> blocking_locks.classid <span class=\"hljs-keyword\">IS</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">DISTINCT</span> <span class=\"hljs-keyword\">FROM</span> blocked_locks.classid\n    <span class=\"hljs-keyword\">AND</span> blocking_locks.objid <span class=\"hljs-keyword\">IS</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">DISTINCT</span> <span class=\"hljs-keyword\">FROM</span> blocked_locks.objid\n    <span class=\"hljs-keyword\">AND</span> blocking_locks.objsubid <span class=\"hljs-keyword\">IS</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">DISTINCT</span> <span class=\"hljs-keyword\">FROM</span> blocked_locks.objsubid\n    <span class=\"hljs-keyword\">AND</span> blocking_locks.pid <span class=\"hljs-operator\">!=</span> blocked_locks.pid\n<span class=\"hljs-keyword\">JOIN</span> pg_catalog.pg_stat_activity blocking_activity <span class=\"hljs-keyword\">ON</span> blocking_activity.pid <span class=\"hljs-operator\">=</span> blocking_locks.pid\n<span class=\"hljs-keyword\">WHERE</span> <span class=\"hljs-keyword\">NOT</span> blocked_locks.granted;\n</code></pre>\n<h3>View Lock Information</h3>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-keyword\">SELECT</span>\n    locktype,\n    relation::regclass,\n    mode,\n    granted,\n    pid\n<span class=\"hljs-keyword\">FROM</span> pg_locks\n<span class=\"hljs-keyword\">WHERE</span> <span class=\"hljs-keyword\">NOT</span> granted;\n</code></pre>\n<h3>Enable Query Logging</h3>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Log long-running queries</span>\n<span class=\"hljs-keyword\">ALTER</span> <span class=\"hljs-keyword\">SYSTEM</span> <span class=\"hljs-keyword\">SET</span> log_min_duration_statement <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">'1000'</span>; <span class=\"hljs-comment\">-- 1 second</span>\n\n<span class=\"hljs-comment\">-- Log lock waits</span>\n<span class=\"hljs-keyword\">ALTER</span> <span class=\"hljs-keyword\">SYSTEM</span> <span class=\"hljs-keyword\">SET</span> log_lock_waits <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">on</span>;\n<span class=\"hljs-keyword\">ALTER</span> <span class=\"hljs-keyword\">SYSTEM</span> <span class=\"hljs-keyword\">SET</span> deadlock_timeout <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">'1s'</span>;\n\n<span class=\"hljs-comment\">-- Apply changes</span>\n<span class=\"hljs-keyword\">SELECT</span> pg_reload_conf();\n</code></pre>\n<h2>Performance Considerations</h2>\n<h3>Transaction ID Wraparound</h3>\n<p>PostgreSQL uses 32-bit transaction IDs that can wrap around. Regular VACUUM prevents this:</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Check age of oldest transaction</span>\n<span class=\"hljs-keyword\">SELECT</span> datname, age(datfrozenxid)\n<span class=\"hljs-keyword\">FROM</span> pg_database\n<span class=\"hljs-keyword\">ORDER</span> <span class=\"hljs-keyword\">BY</span> age(datfrozenxid) <span class=\"hljs-keyword\">DESC</span>;\n\n<span class=\"hljs-comment\">-- Warning occurs at 200 million, emergency at 2 billion</span>\n</code></pre>\n<h3>Bloat from Long Transactions</h3>\n<p>Long transactions prevent VACUUM from cleaning up old row versions:</p>\n<pre><code class=\"hljs language-sql\"><span class=\"hljs-comment\">-- Check table bloat</span>\n<span class=\"hljs-keyword\">SELECT</span>\n    schemaname,\n    tablename,\n    pg_size_pretty(pg_total_relation_size(schemaname<span class=\"hljs-operator\">||</span><span class=\"hljs-string\">'.'</span><span class=\"hljs-operator\">||</span>tablename)) <span class=\"hljs-keyword\">AS</span> size,\n    n_dead_tup\n<span class=\"hljs-keyword\">FROM</span> pg_stat_user_tables\n<span class=\"hljs-keyword\">ORDER</span> <span class=\"hljs-keyword\">BY</span> n_dead_tup <span class=\"hljs-keyword\">DESC</span>;\n</code></pre>\n<h3>Index-Only Scans</h3>\n<p>Ensure visibility map is updated for better performance:</p>\n<pre><code class=\"hljs language-sql\">VACUUM ANALYZE your_table;\n</code></pre>\n<h2>Conclusion</h2>\n<p>Understanding transactions and isolation levels in PostgreSQL is essential for building reliable, concurrent applications. Key takeaways:</p>\n<ul>\n  <li>Use the default Read Committed isolation level for most operations</li>\n  <li>Keep transactions short to minimize locking and bloat</li>\n  <li>Implement retry logic for serialization failures at higher isolation levels</li>\n  <li>Leverage MVCC and avoid unnecessary explicit locking</li>\n  <li>Monitor long-running transactions and blocking queries</li>\n  <li>Use appropriate patterns like SKIP LOCKED for queue processing</li>\n</ul>\n<p>PostgreSQL's sophisticated transaction system provides excellent tools for maintaining data consistency while achieving high concurrency. By understanding these mechanisms and following best practices, you can build robust applications that handle concurrent access gracefully.</p>\n"}},"__N_SSG":true}