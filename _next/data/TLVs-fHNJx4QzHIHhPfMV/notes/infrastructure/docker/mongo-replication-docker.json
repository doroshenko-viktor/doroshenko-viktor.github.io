{"pageProps":{"noteKey":["infrastructure","docker","mongo-replication-docker"],"note":{"title":"Mongo Replication In Docker","date":"2022-05-31","content":"\n<p>\n  Mongo replication allows to build more scalable and fault tolerant systems. But using <code>MongoDb</code>\n  locally usually we use single instance versions. This is fine for many development usecases. But\n  some features, for example Mongo transactions are available only with replication.\n</p>\n<p>\n  We will set up docker compose configuration, which will allow to run several <code>MongoDb</code> containers,\n  able to communicate in mutual network. All these containers will be accessible also from local machine.\n</p>\n<p>To create local instance of <code>MongoDb</code> in cluster but only with single node:</p>\n<pre><code class=\"hljs language-yml\"><span class=\"hljs-attr\">version:</span> <span class=\"hljs-string\">\"3.8\"</span>\n<span class=\"hljs-attr\">services:</span>\n  <span class=\"hljs-attr\">mongodb:</span>\n    <span class=\"hljs-attr\">image :</span> <span class=\"hljs-string\">mongo</span>\n    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">mongodb</span>\n    <span class=\"hljs-attr\">hostname:</span> <span class=\"hljs-string\">mongodb</span>\n    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">on-failure</span>\n    <span class=\"hljs-attr\">environment:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">PUID=1000</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">PGID=1000</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">MONGO_INITDB_ROOT_USERNAME=guest</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">MONGO_INITDB_ROOT_PASSWORD=guest</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">MONGO_INITDB_DATABASE=my-service</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">MONGO_REPLICA_SET_NAME=rs0</span>\n    <span class=\"hljs-attr\">volumes:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">mongodb4_data:/data/db</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">./:/opt/keyfile/</span>\n    <span class=\"hljs-attr\">ports:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-number\">27017</span><span class=\"hljs-string\">:27017</span>\n    <span class=\"hljs-attr\">healthcheck:</span>\n      <span class=\"hljs-attr\">test:</span> <span class=\"hljs-string\">test</span> <span class=\"hljs-string\">$$(echo</span> <span class=\"hljs-string\">\"rs.initiate().ok || rs.status().ok\"</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">mongo</span> <span class=\"hljs-string\">-u</span> <span class=\"hljs-string\">$${MONGO_INITDB_ROOT_USERNAME}</span> <span class=\"hljs-string\">-p</span> <span class=\"hljs-string\">$${MONGO_INITDB_ROOT_PASSWORD}</span> <span class=\"hljs-string\">--quiet)</span> <span class=\"hljs-string\">-eq</span> <span class=\"hljs-number\">1</span>\n      <span class=\"hljs-attr\">interval:</span> <span class=\"hljs-string\">10s</span>\n      <span class=\"hljs-attr\">start_period:</span> <span class=\"hljs-string\">30s</span>\n    <span class=\"hljs-attr\">command:</span> <span class=\"hljs-string\">\"--bind_ip_all --keyFile /opt/keyfile/keyfile --replSet rs0\"</span>\n<span class=\"hljs-attr\">volumes:</span>\n  <span class=\"hljs-attr\">mongodb4_data:</span>\n</code></pre>\n<h2>Resources</h2>\n<ul>\n  <li><a href=\"https://www.sohamkamani.com/docker/mongo-replica-set/\">Creating a MongoDB Replica Set Using Docker</a></li>\n  <li>\n    <a href=\"https://blog.devgenius.io/how-to-deploy-a-mongodb-replicaset-using-docker-compose-a538100db471\"></a><a href=\"https://stackoverflow.com/questions/61486024/mongo-container-with-a-replica-set-with-only-one-node-in-docker-compose\">https://stackoverflow.com/questions/61486024/mongo-container-with-a-replica-set-with-only-one-node-in-docker-compose</a>\n    <a href=\"https://blog.tericcabrel.com/mongodb-replica-set-docker-compose/\">https://blog.tericcabrel.com/mongodb-replica-set-docker-compose/</a>\n  </li>\n</ul>\n"}},"__N_SSG":true}